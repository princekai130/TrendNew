@page "/admin/settings"
@using Microsoft.AspNetCore.Authorization
@using MudBlazor
@inject TrendRepo Repo
@inject ISnackbar Snackbar
@attribute [Authorize(Roles = "Admin")]

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-8">
    <MudText Typo="Typo.h4" Class="mb-6 fw-bold">Admin Control Panel</MudText>

    <MudGrid>
        <MudItem xs="12">
            <MudCard Elevation="4" Class="rounded-xl">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Konfigurasi Sistem & Scraper</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudNumericField @bind-Value="_interval"
                                     Label="Interval Sinkronisasi Otomatis (Jam)"
                                     Variant="Variant.Outlined"
                                     Min="1" Max="168"
                                     HelperText="Data akan dianggap 'basi' setelah jumlah jam ini terlampaui." />

                    @* Hashtag ini sekarang bersifat opsional karena sistem sudah pakai Niche *@
                    <MudTextField @bind-Value="_targetHashtag"
                                  Label="Global Hashtag (Backup)"
                                  Variant="Variant.Outlined"
                                  Class="mt-4"
                                  HelperText="Hashtag cadangan jika pencarian niche gagal." />
                </MudCardContent>
                <MudCardActions>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               OnClick="SaveAllSettings"
                               StartIcon="@Icons.Material.Filled.Save"
                               Class="rounded-lg ml-2 mb-2">Simpan Semua Pengaturan</MudButton>
                </MudCardActions>
            </MudCard>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private int _interval = 24;
    private string _targetHashtag = "skincare";

    protected override async Task OnInitializedAsync()
    {
        // Ambil data Interval
        var valInterval = await Repo.GetSettingAsync("ScrapingIntervalHours");
        if (int.TryParse(valInterval, out var res)) _interval = res;

        // Ambil data Hashtag
        var valHashtag = await Repo.GetSettingAsync("TargetHashtag");
        if (!string.IsNullOrEmpty(valHashtag)) _targetHashtag = valHashtag;
    }

    private async Task SaveAllSettings()
    {
        try
        {
            await Repo.UpdateSettingAsync("ScrapingIntervalHours", _interval.ToString());
            await Repo.UpdateSettingAsync("TargetHashtag", _targetHashtag);
            Snackbar.Add("Semua pengaturan berhasil diperbarui!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add("Gagal menyimpan: " + ex.Message, Severity.Error);
        }
    }
}