@page "/TrendExploler"
@using Trend.MudWeb.Models
@using Microsoft.AspNetCore.Components.Authorization
@inject TrendRepo Repo
@inject AuthenticationStateProvider AuthProvider

<PageTitle>Trend Explorer</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-6">
    <MudStack Direction="Row" Spacing="2" Class="mb-4" AlignItems="AlignItems.Center">
        <MudIcon Icon="@Icons.Material.Filled.Search" Color="Color.Primary" Size="Size.Large" />
        <MudText Typo="Typo.h3">Trend Explorer</MudText>
    </MudStack>

    <MudText Typo="Typo.body1" Class="mb-6">
        Jelajahi tren terbaru berdasarkan kategori niche Anda. Data diambil secara otomatis dari TikTok, Instagram, dan Facebook[cite: 3, 18, 41].
    </MudText>

    <AuthorizeView Context="authContext">
        <Authorized>
            <MudGrid>
                @if (_nicheTrends == null)
                {
                    <MudItem xs="12" Class="d-flex justify-center pa-10">
                        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                    </MudItem>
                }
                else if (!_nicheTrends.Any())
                {
                    <MudItem xs="12">
                        <MudAlert Severity="Severity.Info">Belum ada tren yang ditemukan untuk niche Anda saat ini.</MudAlert>
                    </MudItem>
                }
                else
                {
                    @foreach (var trend in _nicheTrends)
                    {
                        <MudItem xs="12" sm="6" md="4">
                            <MudPaper Elevation="3" Class="pa-4" Style="height: 100%; display: flex; flex-direction: column;">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mb-2">
                                    <MudChip T="string" Color="Color.Primary" Size="Size.Small" Variant="Variant.Text">@trend.Platform</MudChip>
                                    <MudChip T="string" Color="Color.Secondary" Size="Size.Small">@trend.TrendType</MudChip>
                                </MudStack>

                                <MudText Typo="Typo.h6" Class="mt-2">@trend.TrendName</MudText>
                                <MudText Typo="Typo.body2" Class="flex-grow-1 mt-2">
                                    Terdeteksi pada: @trend.DiscoveredAt?.ToString("dd MMM yyyy")
                                </MudText>

                                <MudDivider Class="my-3" />

                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                    <MudText Typo="Typo.caption">Growth Score</MudText>
                                    <MudRating SelectedValue="@((int)(trend.GrowthScore ?? 0) / 2)" ReadOnly="true" MaxValue="5" FullIcon="@Icons.Material.Filled.Whatshot" Color="Color.Error" />
                                </MudStack>

                                <MudButton Variant="Variant.Outlined" Color="Color.Primary" FullWidth="true" Class="mt-4">
                                    Lihat Detail
                                </MudButton>
                            </MudPaper>
                        </MudItem>
                    }
                }
            </MudGrid>
        </Authorized>
        <NotAuthorized>
            <MudAlert Severity="Severity.Warning" Variant="Variant.Filled" Class="mt-4">
                Silakan login untuk menjelajahi tren berdasarkan niche konten Anda.
            </MudAlert>
        </NotAuthorized>
    </AuthorizeView>
</MudContainer>

@code {
    private List<SocialTrend> _nicheTrends;
    private int? _userNicheId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var userClaims = authState.User;

        if (userClaims.Identity.IsAuthenticated)
        {
            // Ambil email dari claim untuk mendapatkan data user dan niche-nya
            var email = userClaims.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value;
            if (!string.IsNullOrEmpty(email))
            {
                var user = await Repo.GetUserByEmailAsync(email);
                _userNicheId = user?.NicheId;

                if (_userNicheId.HasValue)
                {
                    // Mengambil tren yang sesuai dengan niche pengguna [cite: 13, 31]
                    _nicheTrends = await Repo.GetTrendsByNicheAsync(_userNicheId.Value);
                }
            }
        }
    }
}