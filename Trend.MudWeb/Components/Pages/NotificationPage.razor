@page "/notifications"
@using Trend.MudWeb.Models
@using Trend.MudWeb.Services
@using Microsoft.AspNetCore.Components.Authorization
@inject TrendRepo Repo
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthProvider

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap');

    .notif-page-wrapper {
        font-family: 'Outfit', sans-serif;
        background-color: var(--mud-palette-background);
    }

    /* Notif Card - iOS Style */
    .notif-glass-card {
        background: var(--mud-palette-surface);
        border: 1px solid var(--mud-palette-divider);
        border-radius: 20px !important;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
    }

        .notif-glass-card:hover {
            transform: scale(1.01);
            background: var(--mud-palette-background-grey);
        }

        .notif-glass-card.is-unread {
            background: rgba(var(--mud-palette-primary-rgb), 0.04);
            border-left: 5px solid var(--mud-palette-primary) !important;
        }

    .notif-icon-circle {
        width: 48px;
        height: 48px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .unread-indicator {
        width: 10px;
        height: 10px;
        background-color: var(--mud-palette-primary);
        border-radius: 50%;
        box-shadow: 0 0 8px var(--mud-palette-primary);
    }

    .filter-btn-pill {
        border-radius: 12px !important;
        text-transform: none !important;
        font-weight: 600 !important;
    }
</style>

<PageTitle>Inbox Intelijen - Trendz</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="notif-page-wrapper mt-10 mb-16">
    @* --- HEADER --- *@
    <MudGrid AlignItems="AlignItems.Center" Class="mb-8">
        <MudItem xs="12" sm="7">
            <MudText Typo="Typo.h3" Class="fw-bold" Style="letter-spacing: -1.5px;">Inbox Intelijen</MudText>
            <MudText Typo="Typo.body1" Color="Color.Secondary">Wawasan terbaru yang dipersonalisasi untuk niche Anda.</MudText>
        </MudItem>
        <MudItem xs="12" sm="5" Class="d-flex justify-sm-end">
            @if (_dbNotifications?.Any(n => !(n.IsRead ?? false)) ?? false)
            {
                <MudButton OnClick="MarkAllAsRead"
                           Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Rounded.DoneAll"
                           Class="filter-btn-pill px-6 shadow-none">
                    Baca Semua
                </MudButton>
            }
        </MudItem>
    </MudGrid>

    @* --- TAB FILTERS (UX Improvement) --- *@
    <div class="d-flex gap-2 mb-8 overflow-x-auto pb-2">
        <MudChip T="string" Variant="Variant.Filled" Color="Color.Default" Class="filter-btn-pill">Semua</MudChip>
        <MudChip T="string" Variant="Variant.Text" Color="Color.Primary" Class="filter-btn-pill">Rising Trends</MudChip>
        <MudChip T="string" Variant="Variant.Text" Color="Color.Primary" Class="filter-btn-pill">Kompetitor</MudChip>
    </div>

    @if (_dbNotifications == null)
    {
        <MudStack Spacing="3">
            @for (int i = 0; i < 4; i++)
            {
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="100px" Class="rounded-xl" />
            }
        </MudStack>
    }
    else if (!_dbNotifications.Any())
    {
        <div class="text-center py-16 animate__animated animate__fadeIn">
            <div class="d-flex justify-center mb-6">
                <MudIcon Icon="@Icons.Material.TwoTone.AllInbox" Style="font-size: 6rem; opacity: 0.1;" />
            </div>
            <MudText Typo="Typo.h5" Class="fw-bold">Inbox Kosong</MudText>
            <MudText Typo="Typo.body1" Color="Color.Secondary">Semua tren sudah kamu pantau. Kerja bagus!</MudText>
        </div>
    }
    else
    {
        <MudStack Spacing="4">
            @foreach (var note in _dbNotifications)
            {
                bool isUnread = !(note.IsRead ?? false);
                var (icon, color) = GetNotifStyle(note.Message);

                <MudPaper Class="@($"pa-5 notif-glass-card shadow-none {(isUnread ? "is-unread" : "")}")"
                          Elevation="0"
                          OnClick="@(() => isUnread ? MarkAsRead(note) : null)">
                    <MudStack Direction="Row" AlignItems="AlignItems.Center" Spacing="4">

                        @* Icon Section *@
                        <div class="notif-icon-circle" style="background: @(color)20; color: @color;">
                            <MudIcon Icon="@icon" />
                        </div>

                        @* Content Section *@
                        <div style="flex-grow: 1;">
                            <div class="d-flex justify-space-between align-start">
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.body1" Class="@(isUnread ? "fw-bold" : "")" Style="line-height: 1.3;">
                                        @note.Message
                                    </MudText>
                                    <MudText Typo="Typo.caption" Style="opacity: 0.6;" Class="mt-1">
                                        @GetTimeAgo(note.CreatedAt)
                                    </MudText>
                                </MudStack>
                                @if (isUnread)
                                {
                                    <div class="unread-indicator"></div>
                                }
                            </div>
                        </div>

                        @* Action Section *@
                        <MudIconButton Icon="@Icons.Material.Rounded.ChevronRight" Size="Size.Small" Opacity="0.3" />
                    </MudStack>
                </MudPaper>
            }
        </MudStack>
    }
</MudContainer>

@code {
    // Tambahkan helper untuk format waktu yang lebih manusiawi
    private string GetTimeAgo(DateTime dateTime)
    {
        var span = DateTime.Now - dateTime;
        if (span.TotalMinutes < 60) return $"{(int)span.TotalMinutes}m yang lalu";
        if (span.TotalHours < 24) return $"{(int)span.TotalHours}j yang lalu";
        return dateTime.ToString("dd MMM");
    }

    private List<Trend.MudWeb.Models.UserNotification>? _dbNotifications;
    private int _currentUserId;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            var authState = await AuthProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            // Cek apakah user benar-benar terautentikasi
            if (user.Identity?.IsAuthenticated == true)
            {
                var userIdClaim = user.FindFirst("UserId")?.Value;

                if (int.TryParse(userIdClaim, out int userId))
                {
                    // DEBUG: Log ini akan muncul di Terminal VS
                    Console.WriteLine($"[NOTIF] Mengambil data untuk User ID: {userId}");

                    var result = await Repo.GetUserNotificationsAsync(userId);
                    _dbNotifications = result ?? new List<UserNotification>();

                    Console.WriteLine($"[NOTIF] Ditemukan {_dbNotifications.Count} data.");
                }
                else
                {
                    Console.WriteLine("[NOTIF] Gagal mengambil UserId dari Claim.");
                    _dbNotifications = new List<UserNotification>();
                }
            }
            else
            {
                Console.WriteLine("[NOTIF] User belum login.");
                _dbNotifications = new List<UserNotification>();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[NOTIF] ERROR: {ex.Message}");
        }
        finally
        {
            StateHasChanged();
        }
    }

    private async Task MarkAsRead(Trend.MudWeb.Models.UserNotification note)
    {
        note.IsRead = true;
        // AKTIFKAN INI: Simpan ke database
        await Repo.MarkNotificationAsReadAsync(note.NotificationId);

        Snackbar.Add("Ditandai sebagai dibaca", Severity.Success);
        StateHasChanged();
    }

    private async Task MarkAllAsRead()
    {
        if (_dbNotifications == null) return;

        var unreadList = _dbNotifications.Where(n => !(n.IsRead ?? false)).ToList();
        foreach (var note in unreadList)
        {
            note.IsRead = true;
            // AKTIFKAN INI: Simpan ke database
            await Repo.MarkNotificationAsReadAsync(note.NotificationId);
        }

        Snackbar.Add("Semua notifikasi telah dibaca", Severity.Info);
        StateHasChanged();
    }

    // Fungsi Pembantu untuk mengatur Ikon dan Warna berdasarkan isi pesan
    private (string Icon, string Color) GetNotifStyle(string message)
    {
        if (message.Contains("Viral", StringComparison.OrdinalIgnoreCase))
            return (Icons.Material.Rounded.Whatshot, "#FF3D00"); // Merah Api

        if (message.Contains("Kompetitor", StringComparison.OrdinalIgnoreCase))
            return (Icons.Material.Rounded.PersonSearch, "#2979FF"); // Biru

        if (message.Contains("Hot", StringComparison.OrdinalIgnoreCase))
            return (Icons.Material.Rounded.AutoAwesome, "#FFC107"); // Kuning/Emas

        return (Icons.Material.Rounded.Notifications, "#616161"); // Abu-abu default
    }
}