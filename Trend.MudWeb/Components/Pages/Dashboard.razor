@page "/dashboard"
@using Trend.MudWeb.Models
@using Trend.MudWeb.Services
@inject ScrapingService Scraper
@inject TrendAnalyzer Analyzer
@inject Report ReportService
@inject TrendRepo Repo
@inject ISnackbar Snackbar
@rendermode Microsoft.AspNetCore.Components.Web.RenderMode.InteractiveServer
@using MudBlazor

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Product+Sans:wght@400;700&family=Outfit:wght@300;400;600&display=swap');

    .gt-wrapper {
        font-family: 'Outfit', sans-serif;
        background-color: var(--mud-palette-background);
        min-height: 100vh;
        color: var(--mud-palette-text-primary);
    }

    /* Header ala Google Trends */
    .gt-header {
        border-bottom: 1px solid var(--mud-palette-divider);
        background: var(--mud-palette-surface);
        padding: 24px 0;
    }

    .gt-card {
        border: 1px solid var(--mud-palette-divider);
        border-radius: 8px; /* Google cenderung kotak tapi lembut */
        background: var(--mud-palette-surface);
        transition: box-shadow 0.2s ease-in-out;
    }

        .gt-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

    /* Sparkline sederhana */
    .gt-sparkline {
        height: 60px;
        width: 100%;
        background-image: linear-gradient(to right, transparent 0%, var(--mud-palette-primary) 50%, transparent 100%);
        opacity: 0.1;
        mask-image: linear-gradient(to top, black, transparent);
    }

    .gt-rank {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--mud-palette-primary);
        opacity: 0.5;
        width: 40px;
    }

    .gt-chip {
        font-size: 0.7rem;
        font-weight: 700;
        padding: 2px 8px;
        border-radius: 4px;
        background: rgba(var(--mud-palette-primary-rgb), 0.1);
        color: var(--mud-palette-primary);
    }
</style>

<div class="gt-wrapper">
    <div class="gt-header mb-8">
        <MudContainer MaxWidth="MaxWidth.Large">
            <MudStack Direction="Row" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                <MudStack Spacing="0">
                    <div class="d-flex align-center">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" class="mr-2">
                            <path d="M13 2L3 14H12L11 22L21 10H12L13 2Z" fill="var(--mud-palette-primary)" />
                        </svg>
                        <MudText Typo="Typo.h5" Style="font-family: 'Product Sans', sans-serif; font-weight: 400;">Trendz <span style="font-weight: 700;">Market Pulse</span></MudText>
                    </div>
                </MudStack>
                <MudStack Direction="Row" Spacing="2">
                    <MudButton OnClick="RefreshTrends" Variant="Variant.Outlined" Color="Color.Primary" Class="rounded-pill px-6" Disabled="@_isSyncing">
                        @(_isSyncing ? "Menyinkronkan..." : "Update Sekarang")
                    </MudButton>
                </MudStack>
            </MudStack>
        </MudContainer>
    </div>

    <MudContainer MaxWidth="MaxWidth.Large">
        <MudText Typo="Typo.h6" Class="mb-4 fw-bold">Analisis AI Terbaru</MudText>
        <MudPaper Class="pa-6 gt-card shadow-none mb-10" Style="border-left: 6px solid var(--mud-palette-primary);">
            <MudGrid>
                <MudItem xs="12" md="8">
                    <div class="d-flex align-center mb-3">
                        <span class="gt-chip mr-2">TOP PREDICTION</span>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Diperbarui @ReportService.generatedAt.ToString("HH:mm")</MudText>
                    </div>
                    <MudText Typo="Typo.h4" Class="fw-bold mb-3">@(_topTrend?.TrendName ?? "Menganalisis...")</MudText>
                    <MudText Typo="Typo.body1" Style="color: var(--mud-palette-text-secondary); line-height: 1.7;">
                        "@_analysisResult"
                    </MudText>
                </MudItem>
                <MudItem xs="12" md="4" Class="d-flex flex-column align-center justify-center border-left border-dashed">
                    <MudText Typo="Typo.h2" Color="Color.Primary" Class="fw-bold">@_topTrend?.GrowthScore%</MudText>
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">MOMENTUM SCORE</MudText>
                </MudItem>
            </MudGrid>
        </MudPaper>

        <div class="d-flex align-center justify-space-between mb-4">
            <MudText Typo="Typo.h6" Class="fw-bold">Topik yang Sedang Tren</MudText>
            <MudButton Variant="Variant.Text" Color="Color.Primary" EndIcon="@Icons.Material.Filled.ArrowForward">Lihat Semua</MudButton>
        </div>

        <MudGrid Class="mb-10">
            @foreach (var (item, index) in _trends.Take(6).Select((value, i) => (value, i)))
            {
                <MudItem xs="12" md="4">
                    <MudPaper Class="pa-5 gt-card shadow-none d-flex flex-column h-100">
                        <div class="d-flex justify-space-between align-start mb-4">
                            <span class="gt-rank">@(index + 1)</span>
                            <MudIcon Icon="@(item.Platform == "TikTok" ? Icons.Custom.Brands.TikTok : Icons.Custom.Brands.Instagram)" Size="Size.Small" Color="Color.Secondary" />
                        </div>
                        <MudText Typo="Typo.h6" Class="fw-bold mb-1">@item.TrendName</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-4">Eksplorasi di @item.Platform</MudText>

                        <div class="mt-auto">
                            <div class="gt-sparkline mb-2"></div>
                            <div class="d-flex justify-space-between align-center">
                                <MudText Typo="Typo.caption" Style="font-weight: 700;">+@item.GrowthScore%</MudText>
                                <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Color="Color.Success" Size="Size.Small" />
                            </div>
                        </div>
                    </MudPaper>
                </MudItem>
            }
        </MudGrid>

        <MudGrid>
            <MudItem xs="12" md="7">
                <MudText Typo="Typo.h6" Class="mb-4 fw-bold">Ketertarikan Berdasarkan Akun</MudText>
                <MudPaper Class="gt-card shadow-none overflow-hidden">
                    @foreach (var comp in _competitorAlerts.Take(5))
                    {
                        <div class="pa-4 d-flex align-center border-bottom">
                            <MudAvatar Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined" Class="mr-4">@comp.Username[0]</MudAvatar>
                            <div class="flex-grow-1">
                                <MudText Typo="Typo.body2" Class="fw-bold">@@@comp.Username</MudText>
                                <MudProgressLinear Color="Color.Primary" Value="@(new Random().Next(40, 95))" Class="mt-1" Style="height: 4px; border-radius: 2px;" />
                            </div>
                            <MudText Typo="Typo.caption" Class="ml-4" Style="width: 50px;">High</MudText>
                        </div>
                    }
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="5">
                <MudText Typo="Typo.h6" Class="mb-4 fw-bold">Ringkasan Laporan</MudText>
                <MudPaper Class="pa-6 gt-card shadow-none d-flex flex-column" Style="background-color: var(--mud-palette-background-grey);">
                    <MudText Typo="Typo.body2" Class="mb-2">Laporan ID: <b>#@ReportService.reportId</b></MudText>
                    <MudText Typo="Typo.body2" Class="mb-6">Data ini dikumpulkan secara otomatis melalui integrasi API TikTok & Instagram.</MudText>
                    <MudButton Href="/MarketReport" Variant="Variant.Filled" Color="Color.Dark" Class="rounded-pill shadow-none py-2" Style="text-transform: none;">
                        Lihat Detail Laporan
                    </MudButton>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </MudContainer>
</div>

@code {
    // Logic tetap sama
}

@code {
    private bool _isSyncing = false;
    private bool _isLoading = true;
    private List<SocialTrend> _trends = new();
    private SocialTrend _topTrend;
    private string _analysisResult;
    private List<CompetitorData> _competitorAlerts = new();

    // Ganti variabel interval lama dengan ini
    private int _currentInterval = 24;

    protected override async Task OnInitializedAsync()
    {
        // 1. Ambil interval dari database
        var intervalDb = await Repo.GetSettingAsync("ScrapingIntervalHours");

        // 2. Jika ada di DB, gunakan. Jika tidak, tetap 24 (default)
        if (int.TryParse(intervalDb, out var result))
        {
            _currentInterval = result;
        }

        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        _isLoading = true;
        _trends = await Repo.GetTrendsAsync();

        if (_trends.Any())
        {
            await ProcessDataForUI();
            _isLoading = false;
            StateHasChanged();
        }

        var lastTrend = _trends.OrderByDescending(t => t.DiscoveredAt).FirstOrDefault();

        // GUNAKAN _currentInterval DI SINI
        bool isDataStale = lastTrend == null ||
                          (DateTime.Now - lastTrend.DiscoveredAt).Value.TotalHours >= _currentInterval;

        if (isDataStale)
        {
            _ = Task.Run(async () => await ExecuteScrapingFlow());
        }
        _isLoading = false;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Test snackbar setelah render pertama untuk memastikan sudah terinisialisasi
            await Task.Delay(100);
            await InvokeAsync(() =>
            {
                Snackbar.Add("Dashboard berhasil dimuat!", Severity.Info);
                StateHasChanged();
            });
        }
    }

    private void TestSnackbar()
    {
        try
        {
            Snackbar.Add("✅ Tes Snackbar Berhasil! Sistem notifikasi berfungsi normal.", Severity.Success);
            Console.WriteLine("TestSnackbar called successfully");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"TestSnackbar error: {ex.Message}");
        }
    }


    private async Task RefreshTrends()
    {
        if (_isSyncing) return;

        var lastTrend = _trends.OrderByDescending(t => t.DiscoveredAt).FirstOrDefault();

        if (lastTrend != null)
        {
            var timePassed = DateTime.Now - lastTrend.DiscoveredAt;
            double hoursPassed = timePassed.Value.TotalHours;

            if (hoursPassed < _currentInterval)
            {
                var remaining = (int)Math.Ceiling(_currentInterval - hoursPassed);
                Snackbar.Add($"Data masih baru. Refresh manual tersedia dalam {remaining} jam lagi.", Severity.Info);
                return;
            }
        }

        Snackbar.Add("Memulai penarikan data terbaru dari TikTok...", Severity.Info);
        await ExecuteScrapingFlow();
    }

    private async Task ExecuteScrapingFlow()
    {
        await InvokeAsync(() =>
        {
            _isSyncing = true;
            StateHasChanged();
        });

        try
        {
            var freshData = await Scraper.FetchTrendData();
            if (freshData != null && freshData.Any())
            {
                await Repo.SaveTrendRangeAsync(freshData);
                _trends = await Repo.GetTrendsAsync();
                await ProcessDataForUI();

                await InvokeAsync(() =>
                {
                    Snackbar.Add("✅ Data berhasil diperbarui dari API!", Severity.Success);
                    StateHasChanged();
                });
            }
            else
            {
                await InvokeAsync(() =>
                {
                    Snackbar.Add("⚠️ Tidak ada data baru ditemukan", Severity.Warning);
                    StateHasChanged();
                });
            }
        }
        catch (Exception ex)
        {
            var detailedError = ex.Message;
            if (ex.InnerException != null) detailedError += " -> " + ex.InnerException.Message;

            await InvokeAsync(() =>
            {
                Snackbar.Add($"❌ Gagal Sinkronisasi: {detailedError}", Severity.Error);
                StateHasChanged();
            });
        }
        finally
        {
            await InvokeAsync(() =>
            {
                _isSyncing = false;
                StateHasChanged();
            });
        }
    }

    private async Task ProcessDataForUI()
    {
        if (_trends.Any())
        {
            _topTrend = _trends.OrderByDescending(t => t.GrowthScore).First();
            var analysisInput = new TrendData
            {
                Keyword = _topTrend.TrendName,
                Platform = _topTrend.Platform,
                GrowthScore = _topTrend.GrowthScoreValue
            };
            _analysisResult = Analyzer.AnalyzeTrend(analysisInput);
            ReportService.GenerateReport(_analysisResult);
        }
    }
}
