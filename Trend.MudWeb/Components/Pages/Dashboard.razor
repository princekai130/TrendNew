@page "/dashboard"
@using Trend.MudWeb.Models
@using Trend.MudWeb.Services
@using System.Security.Claims
@inject ScrapingService Scraper
@inject TrendAnalyzer Analyzer
@inject Report ReportService
@inject TrendRepo Repo
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthStateProvider
@rendermode Microsoft.AspNetCore.Components.Web.RenderMode.InteractiveServer

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap');

    .dashboard-wrapper {
        font-family: 'Outfit', sans-serif;
        background-color: var(--mud-palette-background);
        padding-bottom: 50px;
    }

    /* AI Highlight Card */
    .ai-spotlight {
        background: linear-gradient(135deg, var(--mud-palette-surface) 0%, rgba(89, 74, 226, 0.08) 100%);
        border: 1px solid var(--mud-palette-divider);
        border-radius: 28px;
        position: relative;
    }

    .trend-bento-card {
        background: var(--mud-palette-surface);
        border: 1px solid var(--mud-palette-divider);
        border-radius: 20px;
        transition: all 0.3s ease;
    }

    /* Perbaikan kontras teks platform */
    .platform-tag {
        padding: 4px 12px;
        border-radius: 8px;
        font-size: 0.75rem;
        font-weight: 800;
        text-transform: uppercase;
    }

    .tiktok-tag {
        background: rgba(var(--mud-palette-text-primary-rgb), 0.1);
        color: var(--mud-palette-text-primary); /* Mengikuti tema dark/light */
    }

    .ig-tag {
        background: rgba(225, 48, 108, 0.1);
        color: #E1306C;
    }

    .hashtag-chip {
        background: rgba(var(--mud-palette-primary-rgb), 0.1) !important;
        color: var(--mud-palette-primary) !important;
        font-weight: 600 !important;
        border: 1px solid rgba(var(--mud-palette-primary-rgb), 0.2) !important;
    }

    .report-btn-custom {
        background-color: #FFFFFF !important; /* Putih bersih agar kontras di BG Ungu */
        color: var(--mud-palette-primary) !important;
        font-weight: 800 !important;
        border-radius: 14px !important;
    }
</style>

<div class="dashboard-wrapper">
    @* --- HEADER --- *@
    <MudContainer MaxWidth="MaxWidth.Large" Class="mt-8 mb-6">
        <MudStack Direction="Row" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
            <MudStack Spacing="0">
                <MudText Typo="Typo.h4" Class="fw-bold" Style="letter-spacing: -1.5px;">Market Intelligence</MudText>
                @* TAMPILKAN NAMA NICHE USER *@
                <MudText Typo="Typo.caption" Color="Color.Secondary">Analisis real-time untuk niche <b>@_userNicheName</b>.</MudText>
            </MudStack>
            <MudButton OnClick="RefreshTrends" Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Rounded.Sync" Class="rounded-xl px-6 py-2 shadow-none" Disabled="@_isSyncing">
                @(_isSyncing ? "Menyinkronkan..." : "Sinkronisasi")
            </MudButton>
        </MudStack>
    </MudContainer>

    <MudContainer MaxWidth="MaxWidth.Large">
        @if (_isLoading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-7" />
        }
        else
        {
            <MudGrid>
                @* --- AI SPOTLIGHT --- *@
                <MudItem xs="12">
                    <MudPaper Class="pa-8 ai-spotlight shadow-none" Elevation="0">
                        <MudGrid AlignItems="AlignItems.Center">
                            <MudItem xs="12" md="7">
                                <MudStack Spacing="2">
                                    <MudChip T="string" Color="Color.Primary" Variant="Variant.Text" Size="Size.Small" Icon="@Icons.Material.Rounded.AutoAwesome" Class="fw-bold pa-0">AI INSIGHT - @_userNicheName</MudChip>
                                    <MudText Typo="Typo.h3" Class="fw-bold mt-2">@(_topTrend?.TrendName ?? "Belum ada tren")</MudText>
                                    <MudText Typo="Typo.body1" Style="opacity: 0.8; line-height: 1.8;">
                                        "@_analysisResult"
                                    </MudText>
                                </MudStack>
                            </MudItem>
                            <MudItem xs="12" md="5">
                                <MudPaper Class="pa-4 rounded-xl shadow-none" Style="background: rgba(var(--mud-palette-primary-rgb), 0.05); border: 1px dashed var(--mud-palette-primary);">
                                    <MudText Typo="Typo.caption" Class="fw-bold mb-2 d-block">MOMENTUM SKOR</MudText>
                                    <div class="text-center mt-2">
                                        <MudText Typo="Typo.h2" Color="Color.Primary" Class="fw-bold">@(_topTrend?.GrowthScore ?? 0)%</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Confidence Score di Niche Anda</MudText>
                                    </div>
                                </MudPaper>
                            </MudItem>
                        </MudGrid>
                    </MudPaper>
                </MudItem>

                @* --- RISING TRENDS (FILTERED BY NICHE) --- *@
                <MudItem xs="12" Class="mt-6">
                    <MudText Typo="Typo.h6" Class="fw-bold mb-4">Tren Naik di @_userNicheName</MudText>
                    <MudGrid Spacing="3">
                        @foreach (var item in _trends.Take(3))
                        {
                            <MudItem xs="12" md="4">
                                <MudPaper Class="pa-6 trend-bento-card shadow-none">
                                    <div class="platform-tag mb-4 @(item.Platform == "TikTok" ? "tiktok-tag" : "ig-tag")">@item.Platform</div>
                                    <MudText Typo="Typo.h6" Class="fw-bold">@item.TrendName</MudText>
                                    <MudText Typo="Typo.h5" Color="Color.Success" Class="fw-bold mt-2">+@item.GrowthScore%</MudText>
                                </MudPaper>
                            </MudItem>
                        }
                    </MudGrid>
                </MudItem>
            </MudGrid>
        }
    </MudContainer>
</div>

@code {
    private List<SocialTrend> _trends = new();
    private SocialTrend? _topTrend;
    private string _analysisResult = "Menunggu analisis AI...";
    private string _userNicheName = "Niche Anda";
    private int _currentUserId;
    private int _currentUserNicheId;
    private bool _isLoading = true;
    private bool _isSyncing = false;
    private int _currentInterval = 24;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserDataAndData();
    }

    private async Task LoadUserDataAndData()
    {
        _isLoading = true;

        // 1. Ambil User Info dari Claims
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            _currentUserId = int.Parse(user.FindFirst("UserId")?.Value ?? "0");

            // Ambil NicheId dari database agar selalu fresh
            var userDb = await Repo.GetUserByIdAsync(_currentUserId);
            if (userDb != null)
            {
                _currentUserNicheId = userDb.NicheId ?? 0;
                _userNicheName = userDb.Niche?.NicheName ?? "Niche Umum";
            }
        }

        // 2. Ambil Interval Scraping
        var intervalDb = await Repo.GetSettingAsync("ScrapingIntervalHours");
        if (int.TryParse(intervalDb, out var result)) _currentInterval = result;

        // 3. AMBIL DATA TREN BERDASARKAN NICHE
        _trends = await Repo.GetTrendsByNicheAsync(_currentUserNicheId);

        if (_trends.Any())
        {
            await ProcessDataForUI();
        }

        // 4. Auto-Scraping jika data basi
        var lastTrend = _trends.OrderByDescending(t => t.DiscoveredAt).FirstOrDefault();
        bool isDataStale = lastTrend == null || (DateTime.Now - lastTrend.DiscoveredAt).Value.TotalHours >= _currentInterval;

        if (isDataStale)
        {
            _ = Task.Run(async () => await ExecuteScrapingFlow());
        }

        _isLoading = false;
        StateHasChanged();
    }

    private async Task ExecuteScrapingFlow()
    {
        await InvokeAsync(() => { _isSyncing = true; StateHasChanged(); });
        Console.WriteLine("--- MEMULAI SCRAPING ---"); // LOG BARU

        try
        {
            var freshData = await Scraper.FetchTrendDataByNiche(_currentUserNicheId);

            if (freshData != null && freshData.Any())
            {
                Console.WriteLine($"--- BERHASIL DAPAT {freshData.Count} DATA DARI API ---"); // LOG BARU
                await Repo.SaveTrendRangeAsync(freshData, _currentUserNicheId);
                Console.WriteLine("--- BERHASIL SIMPAN KE DATABASE ---"); // LOG BARU

                // Refresh UI
                _trends = await Repo.GetTrendsByNicheAsync(_currentUserNicheId);
                await ProcessDataForUI();
            }
            else
            {
                Console.WriteLine("--- API TIDAK MENGEMBALIKAN DATA (KOSONG) ---");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"--- ERROR SCRAPING: {ex.Message} ---");
        }
        finally
        {
            await InvokeAsync(() => { _isSyncing = false; StateHasChanged(); });
        }
    }

    private async Task ProcessDataForUI()
    {
        if (_trends.Any())
        {
            _topTrend = _trends.OrderByDescending(t => t.GrowthScore).First();
            var analysisInput = new TrendData
            {
                Keyword = _topTrend.TrendName,
                Platform = _topTrend.Platform,
                GrowthScore = _topTrend.GrowthScoreValue
            };
            _analysisResult = Analyzer.AnalyzeTrend(analysisInput);
            ReportService.GenerateReport(_analysisResult);
        }
    }

    private async Task RefreshTrends()
    {
        if (_isSyncing) return;

        _isSyncing = true;
        StateHasChanged();

        try
        {
            // Panggil langsung tanpa Task.Run untuk debugging agar error muncul di console
            await ExecuteScrapingFlow();
        }
        catch (Exception ex)
        {
            Snackbar.Add("Error: " + ex.Message, Severity.Error);
            Console.WriteLine("CRITICAL ERROR: " + ex.ToString());
        }
        finally
        {
            _isSyncing = false;
            StateHasChanged();
        }
    }
}