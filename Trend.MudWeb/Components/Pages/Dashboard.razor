@page "/dashboard"
@using Microsoft.AspNetCore.Components.Authorization
@using Trend.MudWeb.Models
@inject TrendRepo Repo
@inject AuthenticationStateProvider AuthProvider

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-8">
    <AuthorizeView Context="authContext">
        <Authorized>
            @* Sapaan User berdasarkan data otentikasi *@
            <MudText Typo="Typo.h4">Halo, @authContext.User.Identity.Name!</MudText>
            <MudText Class="mb-8">Berikut adalah ringkasan tren sosial media untuk Anda.</MudText>

            <MudGrid>
                @* FITUR GRATIS: Dapat diakses oleh 92,6% responden yang bersedia mencoba versi gratis  *@
                <MudItem xs="12" md="6">
                    <MudPaper Class="pa-4" Elevation="3">
                        <MudText Typo="Typo.h6" Class="mb-4">🔥 Tren Viral (TikTok & Instagram)</MudText>
                        @if (_viralTrends == null)
                        {
                            <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
                        }
                        else
                        {
                            @foreach (var trend in _viralTrends)
                            {
                                <MudAlert Severity="Severity.Normal" Variant="Variant.Outlined" Class="mt-2">
                                    @trend.TrendName (@trend.Platform)
                                </MudAlert>
                            }
                        }
                    </MudPaper>
                </MudItem>

                @* FITUR PREMIUM: Ditujukan untuk monetisasi fitur Insight Kompetitor (diminati 85,2% responden)  *@
                <MudItem xs="12" md="6">
                    @* Perbaikan: Menggunakan Context="premiumContext" untuk menghindari error RZ9999 *@
                    <AuthorizeView Policy="PremiumOnly" Context="premiumContext">
                        <Authorized>
                            <MudPaper Class="pa-4" Style="border: 2px solid var(--mud-palette-primary); height: 100%;">
                                <MudStack Row="true" Justify="Justify.SpaceBetween">
                                    <MudText Typo="Typo.h6">📊 Analisis Kompetitor</MudText>
                                    <MudChip T="string" Color="Color.Primary" Size="Size.Small">PREMIUM</MudChip>
                                </MudStack>
                                <MudText Class="mt-4">Data performa kompetitor sedang dianalisis secara otomatis.</MudText>
                                <MudButton Variant="Variant.Text" Color="Color.Primary" Class="mt-auto">Lihat Laporan Lengkap</MudButton>
                            </MudPaper>
                        </Authorized>
                        <NotAuthorized>
                            @* Strategi upselling untuk 81,5% yang merasa belum ada platform serupa  *@
                            <MudPaper Class="pa-4" Style="background-color: var(--mud-palette-background-grey); height: 100%;">
                                <MudStack AlignItems="AlignItems.Center" Spacing="2">
                                    <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Large" Color="Color.Warning" />
                                    <MudText Typo="Typo.h6">Fitur Terkunci</MudText>
                                    <MudText Typo="Typo.body2" Align="Align.Center">
                                        Ingin tahu performa kompetitor? 85,2% kreator menggunakan fitur ini untuk tetap unggul.
                                    </MudText>
                                    <MudButton Variant="Variant.Filled" Color="Color.Primary">Upgrade ke Premium</MudButton>
                                </MudStack>
                            </MudPaper>
                        </NotAuthorized>
                    </AuthorizeView>
                </MudItem>
            </MudGrid>
        </Authorized>

        <NotAuthorized>
            <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="mt-4">
                Anda harus login untuk melihat dashboard TRENDZ.
            </MudAlert>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-4" Href="/login">
                Ke Halaman Login
            </MudButton>
        </NotAuthorized>
    </AuthorizeView>
</MudContainer>

@code {
    private List<SocialTrend> _viralTrends;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        if (authState.User.Identity.IsAuthenticated)
        {
            // Memenuhi kebutuhan automasi tanpa manual harian
            _viralTrends = await Repo.GetViralTrendsAsync();
        }
    }
}