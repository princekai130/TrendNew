@page "/MarketReport"
@using Trend.MudWeb.Models
@using Trend.MudWeb.Services
@inject TrendRepo Repo
@inject AuthenticationStateProvider AuthStateProvider
@attribute [Authorize]

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;700&display=swap');

    .report-card {
        background: var(--mud-palette-surface);
        border-radius: 24px;
        border: 1px solid var(--mud-palette-divider);
        transition: transform 0.3s ease;
    }

    .stat-value {
        font-family: 'Outfit', sans-serif;
        font-weight: 800;
        letter-spacing: -1px;
    }
</style>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-10 mb-16">
    <MudStack Direction="Row" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-8">
        <MudStack Spacing="0">
            <MudText Typo="Typo.h3" Class="fw-bold">Market Analysis</MudText>
            <MudText Typo="Typo.body1" Color="Color.Secondary">Laporan komprehensif performa niche <b>@_userNiche</b>.</MudText>
        </MudStack>
        <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Download" Color="Color.Primary" Class="rounded-pill">Export PDF</MudButton>
    </MudStack>

    <MudGrid>
        @* --- STATS SUMMARY --- *@
        @foreach (var stat in _reportData)
        {
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Class="pa-6 report-card shadow-none text-center">
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="fw-bold">@stat.Key.ToUpper()</MudText>
                    <MudText Typo="Typo.h3" Color="Color.Primary" Class="stat-value mt-2">@stat.Value</MudText>
                </MudPaper>
            </MudItem>
        }

        @* --- CHART SECTION --- *@
        <MudItem xs="12" md="8" Class="mt-6">
            <MudPaper Class="pa-8 report-card shadow-none h-100">
                <MudText Typo="Typo.h6" Class="fw-bold mb-4">Volume Tren per Platform</MudText>
                <MudChart ChartType="ChartType.Bar" ChartSeries="@_chartSeries" XAxisLabels="@_chartLabels" Width="100%" Height="300px" />
            </MudPaper>
        </MudItem>

        @* --- RECENT ACTIVITY --- *@
        <MudItem xs="12" md="4" Class="mt-6">
            <MudPaper Class="pa-8 report-card shadow-none h-100">
                <MudText Typo="Typo.h6" Class="fw-bold mb-4">Status Niche</MudText>
                <MudStack Spacing="4">
                    <div class="d-flex justify-space-between">
                        <MudText Typo="Typo.body2">Kesehatan Tren</MudText>
                        <MudChip T="string" Color="Color.Success" Size="Size.Small" Variant="Variant.Text">Sangat Stabil</MudChip>
                    </div>
                    <MudDivider />
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        Berdasarkan data terakhir, niche @_userNiche didominasi oleh konten @(_reportData.ContainsKey("TikTok") && _reportData["TikTok"] > 0 ? "TikTok" : "Instagram").
                        Saran: Fokus pada video durasi pendek.
                    </MudText>
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private Dictionary<string, int> _reportData = new();
    private string _userNiche = "Loading...";
    private List<ChartSeries> _chartSeries = new();
    private string[] _chartLabels = { "TikTok", "Instagram" };
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        _isLoading = true;
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userIdStr = authState.User.FindFirst("UserId")?.Value;

            if (int.TryParse(userIdStr, out int userId))
            {
                var user = await Repo.GetUserByIdAsync(userId);
                _userNiche = user?.Niche?.NicheName ?? "Umum";
                int nicheId = user?.NicheId ?? 0;

                // 1. Ambil data yang sudah difilter berdasarkan Niche ID
                _reportData = await Repo.GetMarketReportStatsByNicheAsync(nicheId);

                // 2. Siapkan data Chart
                _chartSeries.Clear();
                _chartSeries.Add(new ChartSeries
                {
                    Name = "Volume Tren",
                    Data = new double[] {
                        _reportData.GetValueOrDefault("TikTok", 0),
                        _reportData.GetValueOrDefault("Instagram", 0)
                    }
                });
            }
        }
        finally
        {
            _isLoading = false;
        }
    }
}