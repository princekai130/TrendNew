@page "/MarketReport"
@using Trend.MudWeb.Models
@using Trend.MudWeb.Services
@inject TrendRepo Repo
@inject AuthenticationStateProvider AuthStateProvider
@attribute [Authorize]

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&display=swap');

    .report-wrapper {
        font-family: 'Outfit', sans-serif;
        background-color: var(--mud-palette-background);
    }

    .report-card {
        background: var(--mud-palette-surface);
        border-radius: 28px;
        border: 1px solid var(--mud-palette-divider);
        transition: all 0.3s ease;
    }

        .report-card:hover {
            border-color: var(--mud-palette-primary);
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05);
        }

    .stat-value {
        font-weight: 800;
        letter-spacing: -2px;
        line-height: 1;
    }

    .gradient-text {
        background: linear-gradient(90deg, var(--mud-palette-primary) 0%, #FF4081 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .export-btn {
        background: #000 !important;
        color: white !important;
        font-weight: 700 !important;
        border-radius: 14px !important;
        text-transform: none !important;
    }

    .dark .export-btn {
        background: white !important;
        color: black !important;
    }

    .platform-indicator {
        width: 12px;
        height: 12px;
        border-radius: 4px;
        display: inline-block;
        margin-right: 8px;
    }
</style>

<div class="report-wrapper">
    <MudContainer MaxWidth="MaxWidth.Large" Class="mt-10 mb-16">

        <MudGrid AlignItems="AlignItems.Center" Class="mb-10">
            <MudItem xs="12" md="8">
                <MudStack Spacing="1">
                    <MudText Typo="Typo.h2" Class="fw-bold" Style="letter-spacing: -2px;">
                        Market <span class="gradient-text">Intelligence</span>
                    </MudText>
                    <MudText Typo="Typo.h6" Color="Color.Secondary" Style="font-weight: 400;">
                        Deep-dive analysis niche <span class="fw-bold" style="color: var(--mud-palette-text-primary);">@_userNiche</span> — Updated 2026.
                    </MudText>
                </MudStack>
            </MudItem>
            <MudItem xs="12" md="4" Class="d-flex justify-md-end">
                <MudButton Variant="Variant.Filled"
                           StartIcon="@Icons.Material.Rounded.IosShare"
                           Class="export-btn px-8 py-3 shadow-none">
                    Export Analysis
                </MudButton>
            </MudItem>
        </MudGrid>

        <MudGrid>
            @foreach (var stat in _reportData)
            {
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Class="pa-8 report-card shadow-none d-flex flex-column align-center">
                        <MudText Typo="Typo.caption" Class="fw-bold" Style="letter-spacing: 1.5px; opacity: 0.6;">
                            @stat.Key.ToUpper() VOLUME
                        </MudText>
                        <MudText Typo="Typo.h2" Color="Color.Primary" Class="stat-value mt-3">@stat.Value</MudText>
                        <div class="mt-4 d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Rounded.TrendingUp" Color="Color.Success" Size="Size.Small" Class="mr-1" />
                            <MudText Typo="Typo.caption" Color="Color.Success" Class="fw-bold">RISING</MudText>
                        </div>
                    </MudPaper>
                </MudItem>
            }
        </MudGrid>

        <MudGrid Class="mt-8">
            <MudItem xs="12" md="7">
                <MudPaper Class="pa-8 report-card shadow-none h-100">
                    <div class="d-flex justify-space-between align-center mb-8">
                        <MudText Typo="Typo.h5" Class="fw-bold">Volume Distribution</MudText>
                        <div class="d-flex gap-4">
                            <div class="d-flex align-center"><span class="platform-indicator" style="background:var(--mud-palette-primary)"></span><MudText Typo="Typo.caption">TikTok</MudText></div>
                            <div class="d-flex align-center"><span class="platform-indicator" style="background:var(--mud-palette-secondary)"></span><MudText Typo="Typo.caption">Instagram</MudText></div>
                        </div>
                    </div>

                    @if (_isLoading)
                    {
                        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="300px" Class="rounded-xl" />
                    }
                    else
                    {
                        <MudChart ChartType="ChartType.Bar"
                                  ChartSeries="@_chartSeries"
                                  XAxisLabels="@_chartLabels"
                                  Width="100%" Height="300px"
                                  ChartOptions="@_chartOptions" />
                    }
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="5">
                <MudStack Spacing="6" Class="h-100">
                    <MudPaper Class="pa-8 report-card shadow-none flex-grow-1" Style="background: #0F172A; color: white;">
                        <MudStack Row AlignItems="AlignItems.Center" Class="mb-4">
                            <MudIcon Icon="@Icons.Material.Rounded.AutoAwesome" Color="Color.Primary" />
                            <MudText Typo="Typo.h6" Class="fw-bold">AI Summary</MudText>
                        </MudStack>
                        <MudText Typo="Typo.body1" Style="opacity: 0.8; line-height: 1.8;">
                            Niche <b>@_userNiche</b> menunjukkan pertumbuhan positif sebesar 24% pada platform TikTok.
                            Dominasi konten edukatif berdurasi pendek menjadi kunci utama.
                        </MudText>
                        <MudDivider Class="my-6" Style="background: rgba(255,255,255,0.1);" />
                        <div class="d-flex justify-space-between align-center">
                            <MudText Typo="Typo.caption" Style="opacity: 0.6;">NICHE HEALTH</MudText>
                            <MudChip T="string" Color="Color.Success" Size="Size.Small" Variant="Variant.Filled" Class="fw-bold">EXCELLENT</MudChip>
                        </div>
                    </MudPaper>

                    <MudPaper Class="pa-8 report-card shadow-none">
                        <MudText Typo="Typo.subtitle2" Class="fw-bold mb-4" Color="Color.Secondary">REKOMENDASI STRATEGI</MudText>
                        <MudStack Spacing="3">
                            <div class="d-flex align-start">
                                <MudIcon Icon="@Icons.Material.Rounded.CheckCircle" Color="Color.Primary" Size="Size.Small" Class="mr-3 mt-1" />
                                <MudText Typo="Typo.body2">Prioritaskan kuantitas posting di TikTok (3x/minggu).</MudText>
                            </div>
                            <div class="d-flex align-start">
                                <MudIcon Icon="@Icons.Material.Rounded.CheckCircle" Color="Color.Primary" Size="Size.Small" Class="mr-3 mt-1" />
                                <MudText Typo="Typo.body2">Gunakan Reels Instagram untuk showcase kualitas tinggi.</MudText>
                            </div>
                        </MudStack>
                    </MudPaper>
                </MudStack>
            </MudItem>
        </MudGrid>
    </MudContainer>
</div>

@code {
    private Dictionary<string, int> _reportData = new();
    private string _userNiche = "Loading...";
    private List<ChartSeries> _chartSeries = new();
    private string[] _chartLabels = { "TikTok", "Instagram" };
    private bool _isLoading = true;

    // Perbaikan: Gunakan ShowLegend di dalam ChartOptions
    private ChartOptions _chartOptions = new ChartOptions { ShowLegend = false };

    protected override async Task OnInitializedAsync()
    {
        _isLoading = true;
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userIdStr = authState.User.FindFirst("UserId")?.Value;

            if (int.TryParse(userIdStr, out int userId))
            {
                var user = await Repo.GetUserByIdAsync(userId);
                _userNiche = user?.Niche?.NicheName ?? "Umum";
                int nicheId = user?.NicheId ?? 0;

                _reportData = await Repo.GetMarketReportStatsByNicheAsync(nicheId);

                _chartSeries.Clear();
                _chartSeries.Add(new ChartSeries
                {
                    Name = "Volume Tren",
                    Data = new double[] {
                        _reportData.GetValueOrDefault("TikTok", 0),
                        _reportData.GetValueOrDefault("Instagram", 0)
                    }
                });
            }
        }
        finally
        {
            _isLoading = false;
        }
    }
}