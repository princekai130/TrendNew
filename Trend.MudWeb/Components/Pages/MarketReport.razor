@page "/MarketReport"
@using Microsoft.AspNetCore.Authorization
@using Trend.MudWeb.Models
@using Trend.MudWeb.Services
@inject TrendRepo Repo
@attribute [Authorize(Policy = "PremiumOnly")]

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap');

    .report-container {
        font-family: 'Outfit', sans-serif;
    }

    .report-card {
        background: var(--mud-palette-surface);
        border: 1px solid var(--mud-palette-divider);
        border-radius: 20px !important;
        position: relative;
        overflow: hidden;
    }

    /* Efek Ikon Transparan di Balik Statistik */
    .stat-icon-bg {
        position: absolute;
        bottom: -10px;
        right: -10px;
        font-size: 5rem !important;
        opacity: 0.05;
        transform: rotate(-15deg);
    }

    .strategy-item {
        padding: 16px;
        border-radius: 12px;
        background: var(--mud-palette-background-grey);
        margin-bottom: 12px;
        border-left: 4px solid var(--mud-palette-primary);
        display: flex;
        align-items: center;
    }

    .chart-container {
        background: var(--mud-palette-surface);
        border-radius: 20px;
        padding: 24px;
        border: 1px solid var(--mud-palette-divider);
    }

    .export-btn {
        border-radius: 12px !important;
        text-transform: none !important;
        font-weight: 600 !important;
        letter-spacing: 0;
    }
</style>

<MudContainer MaxWidth="MaxWidth.Large" Class="report-container mt-10 pb-15">
    @* HEADER SECTION *@
    <MudStack Direction="Row" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-10">
        <MudStack Spacing="1">
            <MudText Typo="Typo.h3" Class="fw-bold" Style="letter-spacing: -1.5px;">Market Intelligence</MudText>
            <MudText Typo="Typo.body1" Color="Color.Secondary">Deep-dive analisis performa konten dan sebaran tren platform.</MudText>
        </MudStack>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.PictureAsPdf"
                   Class="export-btn px-6 py-3 shadow-none">
            Export Report
        </MudButton>
    </MudStack>

    <MudGrid>
        @if (_stats == null)
        {
            <MudItem xs="12"><MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="rounded-pill" /></MudItem>
        }
        else
        {
            @* --- KARTU STATISTIK (BENTO STYLE) --- *@
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Class="pa-6 report-card shadow-none" Elevation="0">
                    <MudIcon Icon="@Icons.Material.Filled.DataExploration" Class="stat-icon-bg" />
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="fw-bold">TOTAL DATABASE</MudText>
                    <MudText Typo="Typo.h4" Class="fw-bold mt-2">@_stats["Total"]</MudText>
                    <MudText Typo="Typo.caption" Style="color: var(--mud-palette-success);">+12% vs last week</MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudPaper Class="pa-6 report-card shadow-none" Elevation="0">
                    <MudIcon Icon="@Icons.Material.Filled.Whatshot" Class="stat-icon-bg" Color="Color.Error" />
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="fw-bold">VIRAL PEAK</MudText>
                    <MudText Typo="Typo.h4" Class="fw-bold mt-2" Color="Color.Error">@_stats["Viral"]</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">High momentum detected</MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudPaper Class="pa-6 report-card shadow-none" Elevation="0">
                    <MudIcon Icon="@Icons.Custom.Brands.TikTok" Class="stat-icon-bg" />
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="fw-bold">TIKTOK SHARE</MudText>
                    <MudText Typo="Typo.h4" Class="fw-bold mt-2">@_stats["TikTok"]</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Dominant platform</MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudPaper Class="pa-6 report-card shadow-none" Elevation="0">
                    <MudIcon Icon="@Icons.Custom.Brands.Instagram" Class="stat-icon-bg" />
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="fw-bold">IG REELS SHARE</MudText>
                    <MudText Typo="Typo.h4" Class="fw-bold mt-2">@_stats["Instagram"]</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Steady growth</MudText>
                </MudPaper>
            </MudItem>

            @* --- VISUALISASI DATA --- *@
            <MudItem xs="12" md="6">
                <div class="chart-container h-100">
                    <div class="d-flex align-center justify-space-between mb-6">
                        <MudText Typo="Typo.h6" Class="fw-bold">Platform Distribution</MudText>
                        <MudIcon Icon="@Icons.Material.Filled.PieChart" Color="Color.Primary" />
                    </div>
                    <MudChart ChartType="ChartType.Donut"
                              InputData="@_chartData"
                              InputLabels="@_chartLabels"
                              Width="100%"
                              Height="250px"
                              LegendPosition="Position.Bottom" />
                </div>
            </MudItem>

            @* --- STRATEGIC INSIGHTS --- *@
            <MudItem xs="12" md="6">
                <div class="chart-container h-100">
                    <div class="d-flex align-center justify-space-between mb-6">
                        <MudText Typo="Typo.h6" Class="fw-bold">Strategic Insight AI</MudText>
                        <MudChip T="string" Color="Color.Primary" Size="Size.Small" Variant="Variant.Text">Update: Live</MudChip>
                    </div>

                    <div class="strategy-item">
                        <MudIcon Icon="@Icons.Material.Filled.AutoGraph" Color="Color.Primary" Class="mr-4" />
                        <div>
                            <MudText Typo="Typo.body2" Class="fw-bold">Market Dominance</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Video berdurasi pendek masih menguasai 70% atensi audiens di kedua platform.</MudText>
                        </div>
                    </div>

                    <div class="strategy-item" style="border-left-color: #00bcd4;">
                        <MudIcon Icon="@Icons.Material.Filled.AccessTime" Style="color: #00bcd4;" Class="mr-4" />
                        <div>
                            <MudText Typo="Typo.body2" Class="fw-bold">Golden Hours</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Waktu posting terbaik ditemukan pada pukul 19:00 - 21:00 zona waktu lokal.</MudText>
                        </div>
                    </div>

                    <div class="strategy-item" style="border-left-color: #ff9800;">
                        <MudIcon Icon="@Icons.Material.Filled.GroupWork" Style="color: #ff9800;" Class="mr-4" />
                        <div>
                            <MudText Typo="Typo.body2" Class="fw-bold">Competition Level</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Tingkat persaingan niche Anda saat ini tergolong @(_stats["Total"] > 10 ? "Tinggi (Saturasi)" : "Rendah (Peluang)").</MudText>
                        </div>
                    </div>
                </div>
            </MudItem>
        }
    </MudGrid>
</MudContainer>

@code {
    private Dictionary<string, int>? _stats;
    private double[] _chartData = { };
    private string[] _chartLabels = { "TikTok", "Instagram" };

    protected override async Task OnInitializedAsync()
    {
        _stats = await Repo.GetMarketReportStatsAsync();

        if (_stats != null)
        {
            _chartData = new double[] { _stats["TikTok"], _stats["Instagram"] };
        }
    }
}