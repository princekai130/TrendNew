@page "/UpgradePremium"
@using Microsoft.AspNetCore.Components.Authorization
@using Trend.MudWeb.Services
@inject TrendRepo Repo
@inject AuthenticationStateProvider AuthProvider
@inject NavigationManager NavManager
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-12">
    <MudPaper Class="pa-8 rounded-xl text-center" Elevation="4">
        <MudIcon Icon="@Icons.Material.Filled.Stars" Color="Color.Secondary" Size="Size.Large" Style="font-size: 5rem;" />
        <MudText Typo="Typo.h4" Class="fw-bold mt-4">Trendz Premium</MudText>
        <MudText Typo="Typo.body1" Class="mt-2 mb-8">
            Dapatkan akses penuh ke Strategi Konten AI, Watchlist Kompetitor, dan Laporan Strategis.
        </MudText>

        <MudList T="string" Dense="true" Class="text-start mb-8">
            <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">Analisis Tren TikTok Mendalam</MudListItem>
            <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">Monitoring 10+ Kompetitor</MudListItem>
            <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">Ekspor Laporan PDF Bulanan</MudListItem>
        </MudList>

        <MudButton Variant="Variant.Filled"
                   Color="Color.Secondary"
                   Size="Size.Large"
                   FullWidth="true"
                   OnClick="ProcessUpgrade"
                   StartIcon="@Icons.Material.Filled.Bolt">
            Upgrade Sekarang - Rp 99k/bln
        </MudButton>

        <MudButton Variant="Variant.Text" Class="mt-4" OnClick="@(() => NavManager.NavigateTo("/dashboard"))">
            Mungkin Nanti
        </MudButton>
    </MudPaper>
</MudContainer>

@code {
    private async Task ProcessUpgrade()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var userEmail = authState.User.Identity?.Name ?? "User";

        // 1. Update di Database (Tetap wajib agar permanen)
        await Repo.UpdateUserSubscriptionAsync(userEmail, "Premium");

        // 2. Update State Provider (Agar UI Langsung Berubah)
        if (AuthProvider is CustomAuthStateProvider customProvider)
        {
            customProvider.UpdateSubscriptionStatus(userEmail, "Premium");
            Snackbar.Add("Sukses! Anda sekarang member Premium.", Severity.Success);

            await Task.Delay(1000);
            NavManager.NavigateTo("/dashboard");

        // ... setelah proses update database sukses
        int userId = 1; // Sesuaikan dengan UserId yang login
        await Repo.AddNotificationAsync(userId, "Akun Premium Aktif", "Selamat! Anda sekarang memiliki akses penuh ke fitur Strategist Tools.");
        }
    }
}