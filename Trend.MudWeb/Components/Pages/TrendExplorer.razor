@page "/trendexplorer"
@using Microsoft.AspNetCore.Authorization
@using Trend.MudWeb.Models
@using Trend.MudWeb.Services
@using System.Timers
@inject TrendRepo Repo
@inject ISnackbar Snackbar
@implements IDisposable
@attribute [Authorize]
@inject IDialogService DialogService

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&display=swap');

    .explorer-wrapper {
        font-family: 'Outfit', sans-serif;
        background: var(--mud-palette-background);
    }

    /* Search Bar Modern */
    .search-glass {
        background: var(--mud-palette-surface);
        border: 2px solid var(--mud-palette-divider);
        border-radius: 24px;
        padding: 12px 24px;
        display: flex;
        align-items: center;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

        .search-glass:focus-within {
            border-color: var(--mud-palette-primary);
            transform: scale(1.01);
            box-shadow: 0 10px 30px -10px rgba(var(--mud-palette-primary-rgb), 0.2);
        }

    /* Filter Chips */
    .niche-chip {
        font-weight: 600 !important;
        border-radius: 12px !important;
        padding: 20px 16px !important;
        border: 1px solid var(--mud-palette-divider) !important;
        background: var(--mud-palette-surface) !important;
        transition: 0.3s !important;
    }

        .niche-chip.active {
            background: var(--mud-palette-primary) !important;
            color: white !important;
            border-color: var(--mud-palette-primary) !important;
        }

    /* Trend Card Bento Style */
    .trend-card-explorer {
        background: var(--mud-palette-surface);
        border: 1px solid var(--mud-palette-divider);
        border-radius: 24px !important;
        transition: all 0.3s ease;
        overflow: hidden;
    }

        .trend-card-explorer:hover {
            border-color: var(--mud-palette-primary);
            transform: translateY(-8px);
            box-shadow: 0 15px 35px -10px rgba(0,0,0,0.1);
        }

    .audio-panel {
        background: rgba(var(--mud-palette-primary-rgb), 0.05);
        border: 1px dashed rgba(var(--mud-palette-primary-rgb), 0.3);
        border-radius: 16px;
        padding: 12px;
    }

    .growth-badge {
        font-family: 'JetBrains Mono', monospace;
        font-weight: 800;
        background: rgba(16, 185, 129, 0.1);
        color: #10B981;
        padding: 4px 10px;
        border-radius: 8px;
    }

    .platform-tag {
        font-size: 0.65rem;
        font-weight: 900;
        letter-spacing: 1px;
        padding: 2px 8px;
        border-radius: 6px;
    }

    .tk-tag {
        background: #000;
        color: #fff;
    }

    .ig-tag {
        background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
        color: #fff;
    }
</style>

<PageTitle>Trend Explorer - Trendz</PageTitle>

<div class="explorer-wrapper">
    <MudContainer MaxWidth="MaxWidth.Large" Class="mt-10 mb-16">

        @* --- HEADER --- *@
        <MudStack Class="mb-10 text-center">
            <MudText Typo="Typo.h2" Class="fw-bold" Style="letter-spacing: -2px;">Explore Trends <span style="color: var(--mud-palette-primary);">.</span></MudText>
            <MudText Typo="Typo.h6" Color="Color.Secondary" Style="font-weight: 400;">Temukan audio dan konten yang akan meledak besok pagi.</MudText>
        </MudStack>

        @* --- SEARCH & FILTERS --- *@
        <MudStack Spacing="6" Class="mb-12">
            <div class="search-glass">
                <MudIcon Icon="@Icons.Material.Rounded.Search" Color="Color.Primary" Class="mr-4" Size="Size.Large" />
                <MudTextField @bind-Value="SearchTerm"
                              Placeholder="Cari hashtag, topik, atau musik viral..."
                              Variant="Variant.Text"
                              Underline="false"
                              FullWidth
                              Immediate="true"
                              Style="font-size: 1.1rem; font-weight: 500;" />
                @if (_isSearching)
                {
                    <MudProgressCircular Color="Color.Primary" Size="Size.Small" Indeterminate="true" />
                }
            </div>

            <div class="d-flex flex-wrap gap-3 justify-center">
                <MudChip T="string"
                         Text="All Niches"
                         OnClick="@(() => SelectNiche(0))"
                         Class="@(_selectedNicheId == 0 ? "niche-chip active" : "niche-chip")" />

                @foreach (var niche in _niches)
                {
                    <MudChip T="string"
                             Text="@niche.NicheName"
                             OnClick="@(() => SelectNiche(niche.NicheId))"
                             Class="@(_selectedNicheId == niche.NicheId ? "niche-chip active" : "niche-chip")" />
                }
            </div>
        </MudStack>

        @* --- RESULTS GRID --- *@
        <MudGrid Spacing="4">
            @if (_results != null && _results.Any())
            {
                @foreach (var trend in _results)
                {
                    <MudItem xs="12" sm="6" md="4">
                        <MudPaper Class="pa-6 trend-card-explorer shadow-none d-flex flex-column" Style="height:100%">
                            <MudStack Spacing="5" Class="h-100">
                                @* Platform & Growth *@
                                <div class="d-flex justify-space-between align-center">
                                    <span class="platform-tag @(trend.Platform == "TikTok" ? "tk-tag" : "ig-tag")">
                                        @trend.Platform.ToUpper()
                                    </span>
                                    <div class="growth-badge">
                                        +@((trend.GrowthScore ?? 0).ToString("0"))%
                                    </div>
                                </div>

                                @* Trend Title *@
                                <div style="min-height: 60px;">
                                    <MudText Typo="Typo.h5" Class="fw-bold" Style="line-height: 1.2;">@trend.TrendName</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-1 d-flex align-center">
                                        <MudIcon Icon="@Icons.Material.Rounded.Category" Size="Size.Small" Class="mr-1" />
                                        @(trend.Niche?.NicheName ?? "General")
                                    </MudText>
                                </div>

                                @* Audio Player Panel *@
                                @if (!string.IsNullOrEmpty(trend.SoundName))
                                {
                                    <div class="audio-panel">
                                        <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                            <MudStack Row Spacing="2" AlignItems="AlignItems.Center" Style="overflow: hidden;">
                                                <div style="background: var(--mud-palette-primary); border-radius: 8px; padding: 6px;">
                                                    <MudIcon Icon="@Icons.Material.Rounded.MusicNote" Color="Color.Surface" Size="Size.Small" />
                                                </div>
                                                <div style="overflow: hidden;">
                                                    <MudText Typo="Typo.caption" Class="fw-bold d-block" Style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                                        @trend.SoundName
                                                    </MudText>
                                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Trending Audio</MudText>
                                                </div>
                                            </MudStack>

                                            @if (!string.IsNullOrEmpty(trend.SoundUrl))
                                            {
                                                <MudIconButton Icon="@Icons.Material.Rounded.PlayArrow"
                                                               Variant="Variant.Filled"
                                                               Color="Color.Primary"
                                                               Size="Size.Small"
                                                               Href="@trend.SoundUrl"
                                                               Target="_blank" />
                                            }
                                        </MudStack>
                                    </div>
                                }

                                <MudSpacer />

                                <MudButton Variant="Variant.Outlined"
                                           Color="Color.Primary"
                                           FullWidth
                                           Class="rounded-pill py-2 mt-2"
                                           OnClick="@(() => OpenDetail(trend))"
                                           EndIcon="@Icons.Material.Rounded.Launch"
                                           Style="text-transform: none; font-weight: 700;">
                                    Analisis Detail
                                </MudButton>
                            </MudStack>
                        </MudPaper>
                    </MudItem>
                }
            }
            else if (!_isSearching)
            {
                @* Jika kosong, tampilkan pesan dalam 1 baris grid penuh *@
                <MudItem xs="12">
                    <div class="text-center py-16" style="background: rgba(var(--mud-palette-surface-rgb), 0.5); border-radius: 32px; border: 2px dashed var(--mud-palette-divider);">
                        <MudIcon Icon="@Icons.Material.Rounded.SearchOff" Style="font-size: 4rem; opacity: 0.2;" />
                        <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mt-4">Belum ada data di niche ini.</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Coba ubah kata kunci atau pilih niche lain.</MudText>
                    </div>
                </MudItem>
            }
        </MudGrid>
    </MudContainer>
</div>

@code {
    private string _searchTerm = "";
    private string SearchTerm
    {
        get => _searchTerm;
        set { if (_searchTerm == value) return; _searchTerm = value; StartTimer(); }
    }

    private bool _isSearching = false;
    private List<SocialTrend> _results = new();
    private List<Nich> _niches = new();
    private int _selectedNicheId = 0;
    private Timer? _debounceTimer;

    protected override async Task OnInitializedAsync()
    {
        _niches = await Repo.GetNichesAsync();
        await ExecuteSearch();
    }

    private async Task SelectNiche(int nicheId)
    {
        _selectedNicheId = nicheId;
        await ExecuteSearch();
    }

    private async Task ExecuteSearch()
    {
        _isSearching = true;
        StateHasChanged();

        // Repo sekarang akan mengembalikan data termasuk SoundName dan SoundUrl
        var allResults = await Repo.SearchTrendsAsync(_searchTerm);

        if (_selectedNicheId != 0)
        {
            _results = allResults.Where(t => t.NicheId == _selectedNicheId).ToList();
        }
        else
        {
            _results = allResults;
        }

        _isSearching = false;
        StateHasChanged();
    }

    private void StartTimer()
    {
        _debounceTimer?.Stop();
        _debounceTimer?.Dispose();
        _debounceTimer = new Timer(500);
        _debounceTimer.Elapsed += OnTimerElapsed;
        _debounceTimer.AutoReset = false;
        _debounceTimer.Start();
    }

    private async void OnTimerElapsed(object? sender, ElapsedEventArgs e)
    {
        await InvokeAsync(async () => await ExecuteSearch());
    }

    public void Dispose() => _debounceTimer?.Dispose();

    private async Task OpenDetail(SocialTrend trend)
    {
        var parameters = new DialogParameters<TrendDetailDialog> { { x => x.Trend, trend } };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };

        await DialogService.ShowAsync<TrendDetailDialog>("Detail Tren", parameters, options);
    }
}