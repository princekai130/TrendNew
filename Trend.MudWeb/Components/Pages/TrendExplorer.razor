@page "/trendexplorer"
@using Microsoft.AspNetCore.Authorization
@using Trend.MudWeb.Models
@using Trend.MudWeb.Services
@using System.Timers
@inject TrendRepo Repo
@inject ISnackbar Snackbar
@implements IDisposable
@attribute [Authorize]

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap');

    .explorer-container {
        font-family: 'Outfit', sans-serif;
    }

    .search-wrapper {
        background: var(--mud-palette-surface);
        border: 1px solid var(--mud-palette-divider);
        border-radius: 20px;
        padding: 8px 16px;
        display: flex;
        align-items: center;
        transition: all 0.3s ease;
    }

    .search-wrapper:focus-within {
        border-color: var(--mud-palette-primary);
        box-shadow: 0 0 0 3px rgba(var(--mud-palette-primary-rgb), 0.1);
    }

    .filter-chip {
        transition: all 0.2s ease;
        border: 1px solid var(--mud-palette-divider) !important;
        background: var(--mud-palette-surface) !important;
        cursor: pointer;
    }

    .filter-chip.active {
        background: var(--mud-palette-primary) !important;
        color: white !important;
        box-shadow: 0 4px 12px rgba(var(--mud-palette-primary-rgb), 0.3);
    }

    .trend-card-premium {
        background: var(--mud-palette-surface);
        border: 1px solid var(--mud-palette-divider);
        border-radius: 20px !important;
        transition: all 0.3s ease;
    }
</style>

<MudContainer MaxWidth="MaxWidth.Large" Class="explorer-container mt-10 mb-16">
    @* --- HEADER --- *@
    <MudStack Class="mb-8">
        <MudText Typo="Typo.h3" Class="fw-bold" Style="letter-spacing: -1.5px;">Trend Explorer</MudText>
        <MudText Typo="Typo.body1" Color="Color.Secondary">Telusuri tren viral di berbagai niche industri.</MudText>
    </MudStack>

    @* --- SEARCH & NICHE FILTER AREA --- *@
    <MudStack Spacing="4" Class="mb-10">
        <div class="search-wrapper">
            <MudIcon Icon="@Icons.Material.Rounded.Search" Color="Color.Primary" Class="mr-3" />
            <MudTextField @bind-Value="SearchTerm"
                          Placeholder="Cari topik spesifik..."
                          Variant="Variant.Text"
                          Underline="false"
                          FullWidth
                          Immediate="true" />

            @if (_isSearching)
            {
                <MudProgressCircular Color="Color.Primary" Size="Size.Small" Indeterminate="true" />
            }
        </div>

        @* FILTER BERDASARKAN NICHE DARI DATABASE *@
        <div class="d-flex flex-wrap gap-2">
            <MudChip T="string"
                     Text="Semua Niche"
                     OnClick="@(() => SelectNiche(0))"
                     Class="@(_selectedNicheId == 0 ? "filter-chip active px-4" : "filter-chip px-4")"
                     Variant="Variant.Text" />

            @foreach (var niche in _niches)
            {
                <MudChip T="string"
                         Text="@niche.NicheName"
                         OnClick="@(() => SelectNiche(niche.NicheId))"
                         Class="@(_selectedNicheId == niche.NicheId ? "filter-chip active px-4" : "filter-chip px-4")"
                         Variant="Variant.Text" />
            }
        </div>
    </MudStack>

    @* --- RESULTS --- *@
    @if (_results != null && _results.Any())
    {
        <MudGrid>
            @foreach (var trend in _results)
            {
                <MudItem xs="12" sm="6" md="4">
                    <MudPaper Class="pa-6 trend-card-premium shadow-none">
                        <MudStack Spacing="4">
                            <div class="d-flex justify-space-between align-start">
                                <MudText Typo="Typo.h6" Class="fw-bold">@trend.TrendName</MudText>
                                <MudText Typo="Typo.caption" Class="pa-1 rounded" Style="background:rgba(var(--mud-palette-primary-rgb), 0.1); color:var(--mud-palette-primary); font-weight:800;">
                                    @trend.Platform.ToUpper()
                                </MudText>
                            </div>

                            @* TAMPILKAN NAMA NICHE PADA CARD *@
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                Niche: @(trend.Niche?.NicheName ?? "Umum")
                            </MudText>

                            <div class="d-flex justify-space-between align-end">
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">GROWTH</MudText>
                                    <MudText Typo="Typo.h5" Class="fw-bold" Color="Color.Success">+@trend.GrowthScore%</MudText>
                                </MudStack>
                                <MudIcon Icon="@Icons.Material.Outlined.AutoGraph" Color="Color.Success" />
                            </div>
                        </MudStack>
                    </MudPaper>
                </MudItem>
            }
        </MudGrid>
    }
    else if (!_isSearching)
    {
        <div class="text-center py-16" style="opacity: 0.5;">
            <MudIcon Icon="@Icons.Material.Rounded.SearchOff" Style="font-size: 3rem;" />
            <MudText Typo="Typo.body1">Tidak ada data ditemukan untuk niche ini.</MudText>
        </div>
    }
</MudContainer>

@code {
    private string _searchTerm = "";
    private string SearchTerm
    {
        get => _searchTerm;
        set { if (_searchTerm == value) return; _searchTerm = value; StartTimer(); }
    }

    private bool _isSearching = false;
    private List<SocialTrend> _results = new();
    private List<Nich> _niches = new(); // Menggunakan Nich sesuai model EF Core
    private int _selectedNicheId = 0; // 0 berarti "Semua"
    private Timer? _debounceTimer;

    protected override async Task OnInitializedAsync()
    {
        // 1. Ambil daftar niche untuk filter chips
        _niches = await Repo.GetNichesAsync();
        // 2. Load data awal
        await ExecuteSearch();
    }

    private async Task SelectNiche(int nicheId)
    {
        _selectedNicheId = nicheId;
        await ExecuteSearch();
    }

    private async Task ExecuteSearch()
    {
        _isSearching = true;
        StateHasChanged();

        // Ambil data berdasarkan pencarian
        var allResults = await Repo.SearchTrendsAsync(_searchTerm);

        // Filter berdasarkan Niche jika dipilih (bukan 0)
        if (_selectedNicheId != 0)
        {
            _results = allResults.Where(t => t.NicheId == _selectedNicheId).ToList();
        }
        else
        {
            _results = allResults;
        }

        _isSearching = false;
        StateHasChanged();
    }

    // --- LOGIK DEBOUNCING (Timer) ---
    private void StartTimer()
    {
        _debounceTimer?.Stop();
        _debounceTimer?.Dispose();
        _debounceTimer = new Timer(500);
        _debounceTimer.Elapsed += OnTimerElapsed;
        _debounceTimer.AutoReset = false;
        _debounceTimer.Start();
    }

    private async void OnTimerElapsed(object? sender, ElapsedEventArgs e)
    {
        await InvokeAsync(async () => await ExecuteSearch());
    }

    public void Dispose() => _debounceTimer?.Dispose();
}