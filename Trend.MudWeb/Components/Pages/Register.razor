@page "/register"
@using Trend.MudWeb.Models
@inject TrendRepo Repo
@inject NavigationManager NavManager

<MudContainer MaxWidth="MaxWidth.Small" Class="d-flex align-center justify-center" Style="min-height: 90vh;">
    <MudPaper Elevation="4" Class="pa-8" Width="100%" Style="max-width: 450px; border-radius: 12px;">
        <form action="/api/auth/register" method="post">
            @* Hidden input untuk mengirim ID Niche ke Controller *@
            <input type="hidden" name="nicheId" value="@_selectedNicheId" />

            <MudStack Spacing="4">
                <div class="d-flex flex-column align-center mb-4">
                    <MudIcon Icon="@Icons.Material.Filled.PersonAdd" Color="Color.Primary" Size="Size.Large" />
                    <MudText Typo="Typo.h4" Class="fw-bold">Daftar Trendz</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Otomatisasi pemantauan tren harian [cite: 11]</MudText>
                </div>

                @if (NavManager.Uri.Contains("error=EmailExists"))
                {
                    <MudAlert Severity="Severity.Error" Dense="true" Class="mb-2">Email sudah terdaftar!</MudAlert>
                }

                @* Gunakan Shrink="true" untuk mencegah placeholder bertumpuk *@
                <MudTextField T="string" Name="username" Label="Nama Lengkap" Variant="Variant.Outlined"
                              Required="true" ShrinkLabel="true" Placeholder="Masukkan nama Anda" />

                <MudTextField T="string" Name="email" Label="Email" Variant="Variant.Outlined"
                              InputType="InputType.Email" Required="true" ShrinkLabel="true" Placeholder="nama@email.com" />

                <MudTextField T="string" Name="password" Label="Password" Variant="Variant.Outlined"
                              InputType="InputType.Password" Required="true" ShrinkLabel="true" Placeholder="******" />

                @* Perbaikan MudSelect: Pastikan T="int" dan menampilkan NicheName *@
                <MudSelect T="int" Label="Pilih Niche Konten"
                           @bind-Value="_selectedNicheId"
                           Variant="Variant.Outlined"
                           Required="true"
                           AnchorOrigin="Origin.BottomCenter"
                           ShrinkLabel="true"
                           Placeholder="Pilih kategori bidang Anda">
                    @if (_niches != null && _niches.Any())
                    {
                        @foreach (var niche in _niches)
                        {
                            <MudSelectItem T="int" Value="@niche.NicheId">@niche.NicheName</MudSelectItem>
                        }
                    }
                    else
                    {
                        <MudSelectItem T="int" Disabled="true" Value="0">Memuat data niche...</MudSelectItem>
                    }
                </MudSelect>

                <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled"
                           Color="Color.Primary" Size="Size.Large" FullWidth="true" Class="mt-4">
                    Daftar Sekarang
                </MudButton>

                <MudText Typo="Typo.body2" Align="Align.Center" Class="mt-2">
                    Sudah punya akun? <MudLink Href="/login">Masuk di sini</MudLink>
                </MudText>
            </MudStack>
        </form>
    </MudPaper>
</MudContainer>

@code {
    private List<Nich> _niches = new();
    private int _selectedNicheId;

    protected override async Task OnInitializedAsync()
    {
        // Pastikan Repo mengambil data dari DB SQLite
        var data = await Repo.GetAllNichesAsync();
        if (data != null)
        {
            _niches = data;
            if (_niches.Any())
            {
                _selectedNicheId = _niches.First().NicheId;
            }
        }
    }
}