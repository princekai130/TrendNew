@page "/CompetitorWatchlist"
@using Trend.MudWeb.Models
@using Trend.MudWeb.Services
@using System.Security.Claims
@using System.Globalization
@inject TrendRepo Repo
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject AuthenticationStateProvider AuthStateProvider
@attribute [Authorize(Policy = "PremiumOnly")]

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap');

    .feed-container {
        font-family: 'Outfit', sans-serif;
        padding-top: 20px;
        max-width: 900px !important;
    }

    .social-card {
        background: var(--mud-palette-surface);
        border: 1px solid var(--mud-palette-divider);
        border-radius: 24px !important;
        overflow: hidden;
        margin-bottom: 30px;
        transition: transform 0.3s ease;
    }

        .social-card:hover {
            transform: translateY(-4px);
        }

    .video-wrapper {
        position: relative;
        background: #000;
        width: calc(100% - 20px);
        aspect-ratio: 9 / 13;
        border-radius: 16px;
        overflow: hidden;
        margin: 10px;
    }

    .engagement-badge {
        position: absolute;
        top: 15px;
        right: 15px;
        background: rgba(0,0,0,0.6);
        backdrop-filter: blur(10px);
        color: white;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 700;
        z-index: 10;
        border: 1px solid rgba(255,255,255,0.2);
    }
</style>

<MudContainer MaxWidth="MaxWidth.Large" Class="feed-container">
    <div class="d-flex align-center justify-space-between mb-8">
        <div>
            <MudText Typo="Typo.h4" Class="fw-bold">Competitor Feed</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                Memantau @(_posts?.Count ?? 0) konten terbaru di niche <b>@_userNicheName</b>.
            </MudText>
        </div>
        <MudStack Direction="Row">
            <MudButton OnClick="AutoDiscoverCompetitors"
                       Variant="Variant.Outlined"
                       Color="Color.Secondary"
                       StartIcon="@Icons.Material.Filled.AutoAwesome"
                       Style="border-radius: 12px; text-transform: none;">
                Rekomendasi AI
            </MudButton>
            <MudButton OnClick="OpenAddCompetitorDialog"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Add"
                       Style="border-radius: 12px; text-transform: none;">
                Tambah Manual
            </MudButton>
        </MudStack>
    </div>

    <MudGrid Justify="Justify.Center">
        @if (_isLoading)
        {
            @for (int i = 0; i < 2; i++)
            {
                <MudItem xs="12" md="6">
                    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="500px" Class="rounded-xl" />
                </MudItem>
            }
        }
        else if (_posts == null || !_posts.Any())
        {
            <MudItem xs="12" Class="text-center py-16">
                <MudIcon Icon="@Icons.Material.Rounded.PersonSearch" Size="Size.Large" Color="Color.Default" Style="opacity: 0.3; font-size: 5rem;" />
                <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mt-4">Belum ada kompetitor yang dipantau.</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Klik tombol tambah untuk mulai memantau akun kompetitor Anda.</MudText>
            </MudItem>
        }
        else
        {
            @foreach (var post in _posts)
            {
                <MudItem xs="12" md="6">
                    <MudCard Elevation="0" Class="social-card">
                        <MudCardHeader>
                            <CardHeaderAvatar>
                                <MudAvatar Color="Color.Primary" Size="Size.Small">@post.Competitor.AccountHandle[1].ToString().ToUpper()</MudAvatar>
                            </CardHeaderAvatar>
                            <CardHeaderContent>
                                <MudText Typo="Typo.body2"><b>@post.Competitor.AccountHandle</b></MudText>
                            </CardHeaderContent>
                            <CardHeaderActions>
                                @* Tombol Hapus Disini *@
                                <MudIconButton Icon="@Icons.Material.Filled.DeleteOutline"
                                               Color="Color.Error"
                                               Size="Size.Small"
                                               OnClick="@(() => HandleDelete(post.CompetitorId ?? 0, post.Competitor?.AccountHandle ?? "Unknown"))" />
                            </CardHeaderActions>
                        </MudCardHeader>

                        <div class="video-wrapper">
                            <div class="engagement-badge">
                                <MudIcon Icon="@Icons.Material.Filled.Whatshot" Size="Size.Small" Class="mr-1" Color="Color.Error" />
                                @FormatRate(post.EngagementRate) Rate
                            </div>

                            @if (!string.IsNullOrEmpty(post.PostUrl))
                            {
                                var videoId = ExtractVideoId(post.PostUrl);
                                <iframe src="https://www.tiktok.com/embed/v2/@videoId"
                                        style="width: 100%; height: 100%; border: none;"
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                        allowfullscreen
                                        loading="lazy">
                                </iframe>
                            }
                        </div>

                        <MudCardContent Class="px-4 pb-6">
                            <div class="d-flex justify-space-between align-center mb-2">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">ESTIMATED REACH</MudText>
                                <MudText Typo="Typo.caption" Class="fw-bold" Color="Color.Primary">High Engagement</MudText>
                            </div>
                            <MudProgressLinear Color="Color.Primary"
                                               Value="@GetProgressValue(post.EngagementRate)"
                                               Class="rounded-pill"
                                               Style="height: 8px;" />
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        }
    </MudGrid>
</MudContainer>

@code {
    private double FormatRateValue(object? val)
    {
        if (val == null) return 0.0;
        double.TryParse(val.ToString(), out var res);
        return res;
    }
    private List<CompetitorPost>? _posts;
    private int _currentUserId;
    private string _userNicheName = "";
    private bool _isLoading = true;

    // Fungsi Pembantu untuk menghindari error ToString
    private string FormatRate(object? val)
    {
        if (val == null) return "0.0%";
        double.TryParse(val.ToString(), NumberStyles.Any, CultureInfo.InvariantCulture, out var result);
        return result.ToString("F1") + "%";
    }

    private double GetProgressValue(object? val)
    {
        if (val == null) return 0;
        double.TryParse(val.ToString(), NumberStyles.Any, CultureInfo.InvariantCulture, out var result);
        return result * 10; // Skala progress bar
    }

    protected override async Task OnInitializedAsync()
    {
        await GetUserInfo();
        await LoadData();
    }

    private async Task GetUserInfo()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userClaim = authState.User;
        if (userClaim.Identity?.IsAuthenticated == true)
        {
            var userIdString = userClaim.FindFirst("UserId")?.Value;
            if (int.TryParse(userIdString, out int id))
            {
                _currentUserId = id;
                var user = await Repo.GetUserByIdAsync(_currentUserId);
                _userNicheName = user?.Niche?.NicheName ?? "Umum";
            }
        }
    }

    private async Task LoadData()
    {
        try
        {
            _isLoading = true;
            StateHasChanged();
            var result = await Repo.GetCompetitorPostsAsync(_currentUserId);
            _posts = result ?? new List<CompetitorPost>();
        }
        catch (Exception ex)
        {
            Snackbar.Add("Gagal memuat feed: " + ex.Message, Severity.Error);
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task OpenAddCompetitorDialog()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<AddCompetitorDialog>("Tambah Kompetitor", options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            Snackbar.Add("Berhasil menambah kompetitor. Menarik data...", Severity.Info);
            await LoadData();
        }
    }

    private string ExtractVideoId(string url)
    {
        if (string.IsNullOrEmpty(url)) return "";

        try
        {
            // 1. Bersihkan parameter query (seperti ?is_from_webapp=1...)
            var uri = new Uri(url);
            var path = uri.AbsolutePath; // Mengambil /@user/video/7458123456...

            // 2. Cari bagian yang merupakan sekumpulan angka panjang (ID Video)
            var segments = path.Split('/');
            foreach (var segment in segments)
            {
                // ID TikTok biasanya berupa angka dengan panjang minimal 15 digit
                if (!string.IsNullOrEmpty(segment) && segment.All(char.IsDigit) && segment.Length >= 15)
                {
                    return segment;
                }
            }

            // 3. Fallback jika format URL berbeda (misalnya format /v/12345)
            var lastPart = segments.LastOrDefault();
            if (!string.IsNullOrEmpty(lastPart) && lastPart.All(char.IsDigit))
            {
                return lastPart;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error extracting Video ID from {url}: {ex.Message}");
        }

        return ""; // Mengembalikan kosong jika tidak ditemukan
    }

    private async Task AutoDiscoverCompetitors()
    {
            var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true, CloseButton = true };

            // Kirim parameter UserId dan NicheId agar dialog tahu niche user apa
            var parameters = new DialogParameters<AutoDiscoverDialog>
        {
            { x => x.UserId, _currentUserId },
            { x => x.NicheId, 1 } // Ganti dengan variable niche user yang dinamis
        };

            var dialog = await DialogService.ShowAsync<AutoDiscoverDialog>("Rekomendasi AI", parameters, options);
            var result = await dialog.Result;

            if (!result.Canceled)
            {
                await LoadData(); // Refresh list setelah user memilih akun
            }
    }

    private async Task HandleDelete(int competitorId, string handle)
    {
        // Konfirmasi dulu agar tidak tidak sengaja terhapus
        var result = await DialogService.ShowMessageBox(
            "Hapus Kompetitor",
            $"Apakah Anda yakin ingin berhenti memantau {handle}?",
            yesText: "Hapus", cancelText: "Batal");

        if (result == true)
        {
            var success = await Repo.DeleteCompetitorAsync(competitorId);
            if (success)
            {
                Snackbar.Add($"Berhasil menghapus {handle}", Severity.Success);
                await LoadData(); // Refresh tampilan
            }
            else
            {
                Snackbar.Add("Gagal menghapus kompetitor.", Severity.Error);
            }
        }
    }
}