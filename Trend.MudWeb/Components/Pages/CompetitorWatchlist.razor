@page "/CompetitorWatchlist"
@using Trend.MudWeb.Models
@using Trend.MudWeb.Services
@inject TrendRepo Repo
@inject ISnackbar Snackbar
@attribute [Authorize(Policy = "PremiumOnly")]

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap');

    .feed-container {
        font-family: 'Outfit', sans-serif;
        padding-top: 20px;
        max-width: 900px !important; /* Dibuat lebih ramping seperti feed */
    }

    .social-card {
        background: var(--mud-palette-surface);
        border: 1px solid var(--mud-palette-divider);
        border-radius: 20px !important;
        overflow: hidden;
        transition: transform 0.3s ease;
        margin-bottom: 30px;
    }

    /* Video Wrapper gaya Mobile */
    .video-wrapper {
        position: relative;
        background: #000;
        width: 100%;
        aspect-ratio: 9 / 13; /* Rasio portrait yang pas untuk web */
        border-radius: 12px;
        overflow: hidden;
        margin: 10px;
        width: calc(100% - 20px);
    }

    .video-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 20px;
        background: linear-gradient(transparent, rgba(0,0,0,0.8));
        color: white;
        pointer-events: none;
    }

    .engagement-badge {
        position: absolute;
        top: 15px;
        right: 15px;
        background: rgba(var(--mud-palette-primary-rgb), 0.9);
        color: white;
        padding: 5px 12px;
        border-radius: 10px;
        backdrop-filter: blur(4px);
        font-weight: 700;
        font-size: 0.8rem;
        z-index: 10;
    }

    .platform-icon {
        position: absolute;
        top: 15px;
        left: 15px;
        background: rgba(255,255,255,0.2);
        backdrop-filter: blur(4px);
        padding: 5px;
        border-radius: 50%;
        z-index: 10;
    }

    .interaction-btn {
        transition: all 0.2s;
    }

        .interaction-btn:hover {
            color: var(--mud-palette-primary);
            transform: scale(1.1);
        }
</style>

<MudContainer MaxWidth="MaxWidth.Large" Class="feed-container">
    <div class="d-flex align-center justify-space-between mb-8">
        <div>
            <MudText Typo="Typo.h4" Class="fw-bold">Competitor Feed</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">Memantau konten terbaru dari watchlist Anda.</MudText>
        </div>
        <MudButton StartIcon="@Icons.Material.Filled.Add" Variant="Variant.Filled" Color="Color.Primary" Class="rounded-pill">
            Tambah Kompetitor
        </MudButton>
    </div>

    <MudGrid Justify="Justify.Center">
        @if (_posts == null)
        {
            @for (int i = 0; i < 3; i++)
            {
                <MudItem xs="12" md="6">
                    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="500px" Class="rounded-xl" />
                </MudItem>
            }
        }
        else
        {
            @foreach (var post in _posts)
            {
                <MudItem xs="12" md="6">
                    <MudCard Elevation="0" Class="social-card">
                        @* Header Akun *@
                        <MudCardHeader Class="pa-4">
                            <CardHeaderAvatar>
                                <MudAvatar Color="Color.Primary" Variant="Variant.Filled">
                                    @(post.Competitor?.AccountHandle?[0].ToString().ToUpper() ?? "?")
                                </MudAvatar>
                            </CardHeaderAvatar>
                            <CardHeaderContent>
                                <MudText Typo="Typo.body1" Class="fw-bold">@@@post.Competitor?.AccountHandle</MudText>
                                <MudText Typo="Typo.caption" Style="opacity: 0.6;">Baru saja diposting • @post.Competitor?.Platform</MudText>
                            </CardHeaderContent>
                            <CardHeaderActions>
                                <MudIconButton Icon="@Icons.Material.Filled.MoreVert" Color="Color.Default" />
                            </CardHeaderActions>
                        </MudCardHeader>

                        @* Video Area *@
                        <div class="video-wrapper">
                            <div class="engagement-badge">
                                <MudIcon Icon="@Icons.Material.Filled.Whatshot" Size="Size.Small" Class="mr-1" />
                                @post.EngagementRate%
                            </div>

                            <div class="platform-icon">
                                <MudIcon Icon="@(post.Competitor?.Platform == "TikTok" ? Icons.Custom.Brands.TikTok : Icons.Custom.Brands.Instagram)"
                                         Size="Size.Small" Color="Color.Surface" />
                            </div>

                            @if (!string.IsNullOrEmpty(post.PostUrl))
                            {
                                var videoId = ExtractVideoId(post.PostUrl);
                                <iframe src="https://www.tiktok.com/embed/v2/@videoId"
                                        style="width: 100%; height: 100%; border: none;"
                                        allow="encrypted-media;">
                                </iframe>
                            }
                            else
                            {
                                <div class="d-flex align-center justify-center h-100">
                                    <MudText Color="Color.Surface" Typo="Typo.caption">Video tidak dapat dimuat</MudText>
                                </div>
                            }

                            <div class="video-overlay">
                                <MudText Typo="Typo.body2" Class="fw-bold">Prediksi AI:</MudText>
                                <MudText Typo="Typo.caption" Style="opacity: 0.9;">Konten ini memiliki potensi viral tinggi di niche @post.Competitor?.Platform.</MudText>
                            </div>
                        </div>

                        @* Interaction Bar *@
                        <MudCardContent Class="px-4 py-2">
                            <div class="d-flex align-center gap-4 mb-2">
                                <MudIconButton Icon="@Icons.Material.Filled.AutoGraph" Color="Color.Primary" Size="Size.Medium" Class="interaction-btn pa-1" />
                                <MudIconButton Icon="@Icons.Material.Filled.InsertChartOutlined" Color="Color.Default" Size="Size.Medium" Class="interaction-btn pa-1" />
                                <MudSpacer />
                                <MudIconButton Icon="@Icons.Material.Filled.BookmarkBorder" Color="Color.Default" Size="Size.Medium" Class="interaction-btn pa-1" />
                            </div>

                            <MudDivider Class="my-2" Style="opacity: 0.05;" />

                            <div class="d-flex justify-space-between align-center">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Engagement Tracker</MudText>
                                <MudText Typo="Typo.caption" Class="fw-bold" Color="Color.Primary">Trending</MudText>
                            </div>
                            <MudProgressLinear Color="Color.Primary" Value="@(Convert.ToDouble(post.EngagementRate ?? 0))" Class="mt-1 rounded-pill" Style="height: 6px;" />
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        }
    </MudGrid>
</MudContainer>

@code {
    private List<CompetitorPost>? _posts;
    private int _currentUserId = 1;

    protected override async Task OnInitializedAsync() => await LoadData();

    private async Task LoadData()
    {
        _posts = await Repo.GetCompetitorPostsAsync(_currentUserId);
    }

    private string ExtractVideoId(string url)
    {
        if (string.IsNullOrEmpty(url)) return "";
        var parts = url.Split('/');
        return parts.LastOrDefault()?.Split('?').FirstOrDefault() ?? "";
    }
}