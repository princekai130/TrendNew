@page "/CompetitorWatchlist"
@using Trend.MudWeb.Models
@using Trend.MudWeb.Services
@using System.Security.Claims
@using System.Globalization
@inject TrendRepo Repo
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject AuthenticationStateProvider AuthStateProvider
@attribute [Authorize(Policy = "PremiumOnly")]

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap');

    .feed-container {
        font-family: 'Outfit', sans-serif;
        padding-top: 20px;
    }

    .social-card {
        background: var(--mud-palette-surface);
        border: 1px solid var(--mud-palette-divider);
        border-radius: 32px !important;
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        height: 100%;
    }

        .social-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border-color: var(--mud-palette-primary);
        }

    .video-container-modern {
        position: relative;
        background: #000;
        width: 100%;
        aspect-ratio: 9 / 16;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
    }

    .engagement-floating-badge {
        position: absolute;
        top: 16px;
        right: 16px;
        background: rgba(var(--mud-palette-surface-rgb), 0.85);
        backdrop-filter: blur(8px);
        color: var(--mud-palette-text-primary);
        padding: 6px 14px;
        border-radius: 14px;
        font-size: 0.8rem;
        font-weight: 800;
        z-index: 10;
        border: 1px solid var(--mud-palette-divider);
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .action-btn-pill {
        border-radius: 12px !important;
        text-transform: none !important;
        font-weight: 700 !important;
    }

    .platform-label {
        font-size: 0.65rem;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--mud-palette-text-secondary);
    }
</style>

<MudContainer MaxWidth="MaxWidth.Large" Class="feed-container mb-16">
    @* --- HEADER SECTION --- *@
    <MudGrid AlignItems="AlignItems.Center" Class="mb-10">
        <MudItem xs="12" md="6">
            <MudText Typo="Typo.h3" Class="fw-bold" Style="letter-spacing: -1.5px;">Competitor Feed</MudText>
            <MudText Typo="Typo.body1" Color="Color.Secondary">
                Menganalisis <span class="fw-bold" style="color: var(--mud-palette-primary);">@(_posts?.Count ?? 0) video</span> terbaru di niche <span class="fw-bold">@_userNicheName</span>.
            </MudText>
        </MudItem>
        <MudItem xs="12" md="6" Class="d-flex justify-md-end gap-3">
            <MudButton OnClick="AutoDiscoverCompetitors"
                       Variant="Variant.Outlined"
                       Color="Color.Secondary"
                       StartIcon="@Icons.Material.Rounded.AutoAwesome"
                       Class="action-btn-pill px-6">
                Rekomendasi AI
            </MudButton>
            <MudButton OnClick="OpenAddCompetitorDialog"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Rounded.Add"
                       Class="action-btn-pill px-6 shadow-none">
                Tambah Akun
            </MudButton>
        </MudItem>
    </MudGrid>

    @* --- CONTENT GRID --- *@
    <MudGrid>
        @if (_isLoading)
        {
            @for (int i = 0; i < 3; i++)
            {
                <MudItem xs="12" sm="6" lg="4">
                    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="550px" Class="rounded-xl" />
                </MudItem>
            }
        }
        else if (_posts == null || !_posts.Any())
        {
            <MudItem xs="12" Class="text-center py-16">
                <MudPaper Class="pa-16 rounded-xl border-2 border-dashed border-divider shadow-none">
                    <MudIcon Icon="@Icons.Material.Rounded.PersonSearch" Size="Size.Large" Color="Color.Secondary" Style="opacity: 0.3; font-size: 6rem;" />
                    <MudText Typo="Typo.h5" Class="mt-4 fw-bold">Watchlist Kosong</MudText>
                    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-8">Belum ada akun yang kamu pantau hari ini.</MudText>
                    <MudButton OnClick="OpenAddCompetitorDialog" Variant="Variant.Filled" Color="Color.Primary" Class="action-btn-pill">Mulai Pantau Sekarang</MudButton>
                </MudPaper>
            </MudItem>
        }
        else
        {
            @foreach (var post in _posts)
            {
                <MudItem xs="12" sm="6" lg="4">
                    <MudCard Elevation="0" Class="social-card pa-4">
                        @* Header Akun *@
                        <div class="d-flex align-center justify-space-between mb-4 px-2">
                            <div class="d-flex align-center">
                                <MudAvatar Color="Color.Primary" Variant="Variant.Filled" Size="Size.Medium" Class="mr-3">
                                    @post.Competitor.AccountHandle[1].ToString().ToUpper()
                                </MudAvatar>
                                <div>
                                    <MudText Typo="Typo.body1" Class="fw-bold">@post.Competitor.AccountHandle</MudText>
                                    <div class="platform-label">@post.Competitor.Platform</div>
                                </div>
                            </div>
                            <MudMenu Icon="@Icons.Material.Rounded.MoreVert" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight" Dense="true">
                                <MudMenuItem Icon="@Icons.Material.Rounded.Delete" IconColor="Color.Error" OnClick="@(() => HandleDelete(post.CompetitorId ?? 0, post.Competitor?.AccountHandle ?? "Unknown"))">
                                    Berhenti Pantau
                                </MudMenuItem>
                            </MudMenu>
                        </div>

                        @* Video Player *@
                        <div class="video-container-modern">
                            <div class="engagement-floating-badge">
                                <MudIcon Icon="@Icons.Material.Rounded.Whatshot" Size="Size.Small" Color="Color.Error" />
                                @FormatRate(post.EngagementRate)
                            </div>

                            @if (!string.IsNullOrEmpty(post.PostUrl))
                            {
                                var videoId = ExtractVideoId(post.PostUrl);
                                <iframe src="https://www.tiktok.com/embed/v2/@videoId"
                                        style="width: 100%; height: 100%; border: none;"
                                        allow="autoplay; encrypted-media;"
                                        loading="lazy">
                                </iframe>
                            }
                        </div>

                        @* Statistik Bawah *@
                        <div class="mt-5 px-2">
                            <div class="d-flex justify-space-between align-center mb-2">
                                <MudText Typo="Typo.caption" Class="fw-bold" Color="Color.Secondary">PERFORMANCE INDEX</MudText>
                                <MudText Typo="Typo.caption" Class="fw-bold" Color="Color.Primary">Viral Potential</MudText>
                            </div>
                            <MudProgressLinear Color="Color.Primary"
                                               Value="@GetProgressValue(post.EngagementRate)"
                                               Class="rounded-pill"
                                               Style="height: 10px;" />

                            <div class="mt-4 d-flex justify-space-between">
                                <MudButton Variant="Variant.Text" StartIcon="@Icons.Material.Rounded.Launch" Color="Color.Primary" Size="Size.Small" Href="@post.PostUrl" Target="_blank" Class="fw-bold">View Source</MudButton>
                                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">Updated: @DateTime.Now.ToString("dd MMM")</MudText>
                            </div>
                        </div>
                    </MudCard>
                </MudItem>
            }
        }
    </MudGrid>
</MudContainer>

@code {
    // Logic C# tetap sama seperti kode Anda, hanya merapikan penulisan.
    private List<CompetitorPost>? _posts;
    private int _currentUserId;
    private string _userNicheName = "";
    private bool _isLoading = true;

    private string FormatRate(object? val)
    {
        if (val == null) return "0.0%";
        double.TryParse(val.ToString(), NumberStyles.Any, CultureInfo.InvariantCulture, out var result);
        return result.ToString("F1") + "%";
    }

    private double GetProgressValue(object? val)
    {
        if (val == null) return 0;
        double.TryParse(val.ToString(), NumberStyles.Any, CultureInfo.InvariantCulture, out var result);
        return Math.Min(result * 15, 100); // Skala progress bar maksimal 100
    }

    protected override async Task OnInitializedAsync()
    {
        await GetUserInfo();
        await LoadData();
    }

    private async Task GetUserInfo()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userClaim = authState.User;
        if (userClaim.Identity?.IsAuthenticated == true)
        {
            var userIdString = userClaim.FindFirst("UserId")?.Value;
            if (int.TryParse(userIdString, out int id))
            {
                _currentUserId = id;
                var user = await Repo.GetUserByIdAsync(_currentUserId);
                _userNicheName = user?.Niche?.NicheName ?? "Umum";
            }
        }
    }

    private async Task LoadData()
    {
        try
        {
            _isLoading = true;
            StateHasChanged();
            var result = await Repo.GetCompetitorPostsAsync(_currentUserId);
            _posts = result ?? new List<CompetitorPost>();
        }
        catch (Exception ex)
        {
            Snackbar.Add("Gagal memuat feed: " + ex.Message, Severity.Error);
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task OpenAddCompetitorDialog()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<AddCompetitorDialog>("Tambah Kompetitor", options);
        var result = await dialog.Result;
        if (!result.Canceled) await LoadData();
    }

    private string ExtractVideoId(string url)
    {
        if (string.IsNullOrEmpty(url)) return "";
        try
        {
            var uri = new Uri(url);
            var path = uri.AbsolutePath;
            var segments = path.Split('/');
            foreach (var segment in segments)
            {
                if (!string.IsNullOrEmpty(segment) && segment.All(char.IsDigit) && segment.Length >= 15) return segment;
            }
            var lastPart = segments.LastOrDefault();
            if (!string.IsNullOrEmpty(lastPart) && lastPart.All(char.IsDigit)) return lastPart;
        }
        catch { }
        return "";
    }

    private async Task AutoDiscoverCompetitors()
    {
        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true, CloseButton = true };
        var parameters = new DialogParameters<AutoDiscoverDialog> { { x => x.UserId, _currentUserId } };
        var dialog = await DialogService.ShowAsync<AutoDiscoverDialog>("Rekomendasi AI", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled) await LoadData();
    }

    private async Task HandleDelete(int competitorId, string handle)
    {
        var result = await DialogService.ShowMessageBox("Hapus Kompetitor", $"Berhenti memantau {handle}?", yesText: "Hapus", cancelText: "Batal");
        if (result == true)
        {
            if (await Repo.DeleteCompetitorAsync(competitorId))
            {
                Snackbar.Add($"Berhasil menghapus {handle}", Severity.Success);
                await LoadData();
            }
        }
    }
}