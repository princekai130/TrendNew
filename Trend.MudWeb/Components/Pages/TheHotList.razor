@page "/TheHotList"
@using Microsoft.AspNetCore.Authorization
@using Trend.MudWeb.Models
@using System.Security.Claims
@inject TrendRepo Repo
@inject AuthenticationStateProvider AuthStateProvider
@inject ISnackbar Snackbar
@attribute [Authorize(Policy = "PremiumOnly")]

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;800&display=swap');

    .hotlist-container {
        font-family: 'Outfit', sans-serif;
    }

    .recipe-card {
        background: var(--mud-palette-surface);
        border: 1px solid var(--mud-palette-divider);
        border-radius: 24px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

        .recipe-card:hover {
            transform: translateY(-8px);
            border-color: var(--mud-palette-primary);
            box-shadow: 0 20px 30px -10px rgba(0,0,0,0.1);
        }

    .ai-magic-btn {
        background: linear-gradient(90deg, #594AE2 0%, #FF4081 100%) !important;
        color: white !important;
        font-weight: 700 !important;
        border-radius: 12px !important;
        text-transform: none !important;
    }

    .viral-badge {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(255, 64, 129, 0.1);
        color: #FF4081;
        padding: 4px 12px;
        border-radius: 8px;
        font-size: 0.7rem;
        font-weight: 800;
    }
</style>

<MudContainer MaxWidth="MaxWidth.Large" Class="hotlist-container mt-10">
    <MudStack Direction="Row" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-10">
        <MudStack Spacing="0">
            <MudText Typo="Typo.h3" Class="fw-bold" Style="letter-spacing: -2px;">The Hot List 🔥</MudText>
            <MudText Typo="Typo.body1" Color="Color.Secondary">Resep konten eksklusif untuk niche <b>@_userNicheName</b>.</MudText>
        </MudStack>
        <MudChip T="string" Color="Color.Warning" Variant="Variant.Filled" Icon="@Icons.Material.Filled.AutoAwesome">Premium Access</MudChip>
    </MudStack>

    @if (_isLoading)
    {
        <MudGrid>
            @for (int i = 0; i < 3; i++)
            {
                <MudItem xs="12" md="4">
                    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="250px" Class="rounded-xl" />
                </MudItem>
            }
        </MudGrid>
    }
    else if (!_hotTrends.Any())
    {
        <MudAlert Severity="Severity.Normal" Variant="Variant.Outlined" Class="mt-10 rounded-xl">
            Belum ada tren dengan momentum tinggi di niche @_userNicheName hari ini. Silakan cek kembali nanti!
        </MudAlert>
    }
    else
    {
        <MudGrid>
            @foreach (var trend in _hotTrends)
            {
                <MudItem xs="12" md="6" lg="4">
                    <MudPaper Class="pa-6 recipe-card shadow-none">
                        <div class="viral-badge">@trend.GrowthScore% MOMENTUM</div>

                        <MudStack Spacing="4">
                            <div class="d-flex align-center">
                                <MudIcon Icon="@(trend.Platform == "TikTok" ? Icons.Custom.Brands.TikTok : Icons.Custom.Brands.Instagram)" Size="Size.Small" Class="mr-2" />
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@trend.Platform.ToUpper() TREND</MudText>
                            </div>

                            <MudText Typo="Typo.h5" Class="fw-bold">@trend.TrendName</MudText>

                            <div class="d-flex gap-2">
                                <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Icon="@Icons.Material.Filled.Speed" Color="Color.Info">Mudah</MudChip>
                                <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Icon="@Icons.Material.Filled.Whatshot" Color="Color.Error">Viral</MudChip>
                            </div>

                            <MudDivider Style="opacity: 0.1;" />

                            <div class="d-flex align-center justify-space-between">
                                <MudText Typo="Typo.body2" Color="Color.Secondary">AI Content Hook</MudText>
                                <MudIconButton Icon="@Icons.Material.Rounded.AutoAwesome"
                                               Class="ai-magic-btn"
                                               Size="Size.Small"
                                               OnClick="@(() => GenerateAIIdeas(trend))" />
                            </div>

                            @if (_isGenerating && _selectedTrendId == trend.TrendId)
                            {
                                <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="rounded-pill" />
                            }
                            else if (!string.IsNullOrEmpty(trend.TrendType) && trend.TrendType != "Hashtag" && _selectedTrendId == trend.TrendId)
                            {
                                <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Class="mt-2" Style="border-radius: 12px; font-size: 0.85rem;">
                                    <b>AI Suggestion:</b> @trend.TrendType
                                </MudAlert>
                            }
                        </MudStack>
                    </MudPaper>
                </MudItem>
            }
        </MudGrid>
    }
</MudContainer>

@code {
    private bool _isLoading = true;
    private bool _isGenerating = false;
    private int _selectedTrendId = 0;
    private string _userNicheName = "Niche Anda";
    private List<SocialTrend> _hotTrends = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadHotListData();
    }

    private async Task LoadHotListData()
    {
        _isLoading = true;
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userClaim = authState.User;

            if (userClaim.Identity?.IsAuthenticated == true)
            {
                var userIdStr = userClaim.FindFirst("UserId")?.Value;
                if (int.TryParse(userIdStr, out int userId))
                {
                    var user = await Repo.GetUserByIdAsync(userId);
                    if (user != null)
                    {
                        _userNicheName = user.Niche?.NicheName ?? "Umum";
                        // Ambil tren khusus niche user yang memiliki GrowthScore > 70
                        var allTrends = await Repo.GetTrendsByNicheAsync(user.NicheId ?? 0);
                        _hotTrends = allTrends.Where(t => t.GrowthScore > 5).ToList();
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("Gagal memuat Hot List: " + ex.Message, Severity.Error);
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task GenerateAIIdeas(SocialTrend trend)
    {
        _selectedTrendId = trend.TrendId;
        _isGenerating = true;
        StateHasChanged();

        // Simulasi Logika AI Generative
        await Task.Delay(1500);

        // Kita simpan sementara di kolom TrendType untuk demo hasil AI
        trend.TrendType = $"Gunakan audio '{trend.TrendName}' dan buat konten transisi 'Before-After' yang menonjolkan estetika niche {_userNicheName}!";

        _isGenerating = false;
        StateHasChanged();
    }
}